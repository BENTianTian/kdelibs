<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>BKSYS - Build Kde SYStem: generic.py Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Packages</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>generic.py</h1><a href="generic_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespacegeneric.html">00001</a> <span class="comment">## </span>
<a name="l00002"></a>00002 <span class="comment"># @file </span>
<a name="l00003"></a>00003 <span class="comment"># bksys core </span>
<a name="l00004"></a>00004 <span class="comment"># </span>
<a name="l00005"></a>00005 <span class="comment"># (\@) Thomas Nagy, 2005</span>
<a name="l00006"></a>00006 <span class="comment"># </span>
<a name="l00007"></a>00007 <span class="comment">#  Run scons -h to display the associated help, or look below</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="keyword">import</span> os, re, types, sys, string, shutil, stat, glob
<a name="l00010"></a>00010 <span class="keyword">import</span> SCons.Defaults
<a name="l00011"></a>00011 <span class="keyword">import</span> SCons.Tool
<a name="l00012"></a>00012 <span class="keyword">import</span> SCons.Util
<a name="l00013"></a>00013 <span class="keyword">from</span> SCons.Script.SConscript <span class="keyword">import</span> SConsEnvironment
<a name="l00014"></a>00014 <span class="keyword">from</span> SCons.Options <span class="keyword">import</span> Options, PathOption
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="comment">## CONFIGURATION: write the config.h files</span>
<a name="l00017"></a><a class="code" href="namespacegeneric.html#a21">00017</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a21">write_config_h</a>(lenv):
<a name="l00018"></a>00018         <span class="comment"># put the files into the builddir</span>
<a name="l00019"></a>00019         dest=open(lenv.join(lenv[<span class="stringliteral">'_BUILDDIR_'</span>], <span class="stringliteral">'config.h'</span>), <span class="stringliteral">'w'</span>)
<a name="l00020"></a>00020         dest.write(<span class="stringliteral">'/* defines are added below */\n'</span>)
<a name="l00021"></a>00021 
<a name="l00022"></a>00022         <span class="comment"># write the config.h including all others</span>
<a name="l00023"></a>00023         <span class="keywordflow">if</span> lenv.has_key(<span class="stringliteral">'_CONFIG_H_'</span>):
<a name="l00024"></a>00024                 <span class="keywordflow">for</span> file <span class="keywordflow">in</span> lenv[<span class="stringliteral">'_CONFIG_H_'</span>]: dest.write(<span class="stringliteral">'#include "config-%s.h"\n'</span> % file)
<a name="l00025"></a>00025         dest.write(<span class="stringliteral">'\n'</span>)
<a name="l00026"></a>00026         dest.close()
<a name="l00027"></a>00027 
<a name="l00028"></a>00028         lenv.pprint(<span class="stringliteral">'GREEN'</span>,<span class="stringliteral">'configuration done - run scons to compile now'</span>)
<a name="l00029"></a>00029         lenv.Exit(0)
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="comment">## CONFIGURATION: configure the project - this is the entry point</span>
<a name="l00032"></a><a class="code" href="namespacegeneric.html#a22">00032</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a22">configure</a>(dict):
<a name="l00033"></a>00033         <span class="keyword">from</span> SCons <span class="keyword">import</span> Environment
<a name="l00034"></a>00034         <span class="keyword">import</span> os
<a name="l00035"></a>00035 
<a name="l00036"></a>00036         cp_method  = <span class="stringliteral">'soft-copy'</span>
<a name="l00037"></a>00037         tool_path  = [<span class="stringliteral">'bksys'</span>]
<a name="l00038"></a>00038         build_dir  = <span class="stringliteral">'.'</span>
<a name="l00039"></a>00039         cache_dir  = <span class="stringliteral">'cache'</span>+os.sep
<a name="l00040"></a>00040         config_h   = 0
<a name="l00041"></a>00041         bootstrap  = 0
<a name="l00042"></a>00042         want_rpath = 1
<a name="l00043"></a>00043         use_colors = 0
<a name="l00044"></a>00044 
<a name="l00045"></a>00045         <span class="comment"># process the options</span>
<a name="l00046"></a>00046         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> dict.keys():
<a name="l00047"></a>00047                 <span class="keywordflow">if</span>   key == <span class="stringliteral">'modules'</span>:   mytools    = dict[key].split()
<a name="l00048"></a>00048                 <span class="keywordflow">elif</span> key == <span class="stringliteral">'builddir'</span>:  build_dir  = dict[key]
<a name="l00049"></a>00049                 <span class="keywordflow">elif</span> key == <span class="stringliteral">'config.h'</span>:  config_h   = 1
<a name="l00050"></a>00050                 <span class="keywordflow">elif</span> key == <span class="stringliteral">'cp_method'</span>: cp_method  = dict[key]
<a name="l00051"></a>00051                 <span class="keywordflow">elif</span> key == <span class="stringliteral">'rpath'</span>:     want_rpath = dict[key]
<a name="l00052"></a>00052                 <span class="keywordflow">elif</span> key == <span class="stringliteral">'bootstrap'</span>: bootstrap  = 1
<a name="l00053"></a>00053                 <span class="keywordflow">elif</span> key == <span class="stringliteral">'cachedir'</span>:  cache_dir  = dict[key]
<a name="l00054"></a>00054                 <span class="keywordflow">elif</span> key == <span class="stringliteral">'colorful'</span>:  use_colors = dict[key]
<a name="l00055"></a>00055                 <span class="keywordflow">else</span>: <span class="keywordflow">print</span> <span class="stringliteral">'unknown key: '</span>+key
<a name="l00056"></a>00056 
<a name="l00057"></a>00057         <span class="comment"># rpath flags are wrong (and pointless) on darwin</span>
<a name="l00058"></a>00058         <span class="keywordflow">if</span> sys.platform == <span class="stringliteral">'darwin'</span>:
<a name="l00059"></a>00059                 want_rpath = 0
<a name="l00060"></a>00060 
<a name="l00061"></a>00061         <span class="comment"># make sure the build dir is available</span>
<a name="l00062"></a>00062         <span class="comment"># TODO what if it is in a non-existing subdirectory ? (ita)</span>
<a name="l00063"></a>00063         <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(build_dir): os.mkdir(build_dir)
<a name="l00064"></a>00064 
<a name="l00065"></a>00065         <span class="comment"># now build the environment</span>
<a name="l00066"></a>00066         <span class="keywordflow">if</span> bootstrap:
<a name="l00067"></a>00067                 env = Environment.Environment( ENV=os.environ, BOOTSTRAP_KDE=1,
<a name="l00068"></a>00068                         _BUILDDIR_=build_dir, CACHEDIR=cache_dir, _USECOLORS_=use_colors,
<a name="l00069"></a>00069                         tools=mytools, toolpath=tool_path )
<a name="l00070"></a>00070         <span class="keywordflow">else</span>:
<a name="l00071"></a>00071                 env = Environment.Environment( ENV=os.environ, _BUILDDIR_=build_dir,
<a name="l00072"></a>00072                         _USECOLORS_=use_colors, CACHEDIR=cache_dir,
<a name="l00073"></a>00073                         tools=mytools, toolpath=tool_path )
<a name="l00074"></a>00074 
<a name="l00075"></a>00075         <span class="comment"># at this point the help was displayed if asked to, then quit</span>
<a name="l00076"></a>00076         <span class="keywordflow">if</span> env[<span class="stringliteral">'HELP'</span>]: env.Exit(0)
<a name="l00077"></a>00077 
<a name="l00078"></a>00078         <span class="comment"># disable the rpath in scripts if asked to</span>
<a name="l00079"></a>00079         env[<span class="stringliteral">'_WANT_RPATH_'</span>]=want_rpath
<a name="l00080"></a>00080 
<a name="l00081"></a>00081         env.Append(CPPPATH=[<span class="stringliteral">'#'</span>]) <span class="comment"># ugly hack, remove when possible (ita)</span>
<a name="l00082"></a>00082         env.AppendUnique(LIBPATH=[<span class="stringliteral">'#'</span>, build_dir]) <span class="comment"># ugly hack, remove when possible (ita)</span>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084         <span class="comment"># we want symlinks by default</span>
<a name="l00085"></a>00085         env.SetOption(<span class="stringliteral">'duplicate'</span>, cp_method)
<a name="l00086"></a>00086 
<a name="l00087"></a>00087         <span class="comment"># now the post-configuration</span>
<a name="l00088"></a>00088         <span class="keywordflow">if</span> env[<span class="stringliteral">'_CONFIGURE_'</span>]:
<a name="l00089"></a>00089                 <span class="comment"># write the config.h if we were asked to, then quit</span>
<a name="l00090"></a>00090                 <span class="keywordflow">if</span> config_h: write_config_h(env)
<a name="l00091"></a>00091                 env.Exit(0)
<a name="l00092"></a>00092 
<a name="l00093"></a>00093         <span class="keywordflow">return</span> env
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 <span class="comment">## To make a tarball of the project use 'scons dist'</span>
<a name="l00096"></a><a class="code" href="namespacegeneric.html#a23">00096</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a23">dist</a>(env, appname, version=None):
<a name="l00097"></a>00097         <span class="keyword">import</span> os
<a name="l00098"></a>00098         <span class="keywordflow">if</span> <span class="stringliteral">'dist'</span> <span class="keywordflow">in</span> sys.argv:
<a name="l00099"></a>00099                 sys.path.append(<span class="stringliteral">'bksys'</span>+os.sep+<span class="stringliteral">'unix'</span>)
<a name="l00100"></a>00100                 <span class="keyword">from</span> detect_generic <span class="keyword">import</span> dist
<a name="l00101"></a>00101                 dist(env, appname, version)
<a name="l00102"></a>00102 
<a name="l00103"></a>00103         <span class="keywordflow">if</span> <span class="stringliteral">'distclean'</span> <span class="keywordflow">in</span> sys.argv:
<a name="l00104"></a>00104                 sys.path.append(<span class="stringliteral">'bksys'</span>+os.sep+<span class="stringliteral">'unix'</span>)
<a name="l00105"></a>00105                 <span class="keyword">from</span> detect_generic <span class="keyword">import</span> distclean
<a name="l00106"></a>00106                 distclean(env)
<a name="l00107"></a>00107 
<a name="l00108"></a><a class="code" href="namespacegeneric.html#a24">00108</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a24">pprint</a>(env, col, str, label=''):
<a name="l00109"></a>00109         <span class="keywordflow">if</span> <span class="keywordflow">not</span> env[<span class="stringliteral">'_USECOLORS_'</span>]:
<a name="l00110"></a>00110                 <span class="keywordflow">print</span> <span class="stringliteral">"%s %s"</span> % (str, label)
<a name="l00111"></a>00111                 <span class="keywordflow">return</span>
<a name="l00112"></a>00112         <span class="keywordflow">try</span>: mycol=env[<span class="stringliteral">'BKS_COLORS'</span>][col]
<a name="l00113"></a>00113         <span class="keywordflow">except</span>: mycol=<span class="stringliteral">''</span>
<a name="l00114"></a>00114         <span class="keywordflow">print</span> <span class="stringliteral">"%s%s%s %s"</span> % (mycol, str, env[<span class="stringliteral">'BKS_COLORS'</span>][<span class="stringliteral">'NORMAL'</span>], label)
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 <span class="comment">## class for building binary targets like programs, shared libraries, static libs, loadable modules and convenience libraries </span>
<a name="l00117"></a>00117 <span class="comment">#</span>
<a name="l00118"></a>00118 <span class="comment">#</span>
<a name="l00119"></a><a class="code" href="classgeneric_1_1genobj.html">00119</a> <span class="keyword">class </span><a class="code" href="classgeneric_1_1genobj.html">genobj</a>:
<a name="l00120"></a>00120         <span class="comment">## construct a binary target </span>
<a name="l00121"></a>00121         <span class="comment">#</span>
<a name="l00122"></a>00122         <span class="comment"># @val type of binary object "program", "shlib", staticlib", "module", "convenience"</span>
<a name="l00123"></a>00123         <span class="comment"># @env used scons environment </span>
<a name="l00124"></a>00124         <span class="keyword">def </span>__init__(self, val, env):
<a name="l00125"></a>00125                 <span class="comment"># NOTE: (rh) is kioslave not a kde module ? </span>
<a name="l00126"></a>00126                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> val <span class="keywordflow">in</span> [<span class="stringliteral">"program"</span>, <span class="stringliteral">"shlib"</span>, <span class="stringliteral">"kioslave"</span>, <span class="stringliteral">"staticlib"</span>, <span class="stringliteral">"module"</span>, <span class="stringliteral">"convenience"</span>]:
<a name="l00127"></a>00127                         env.pprint(<span class="stringliteral">'RED'</span>, <span class="stringliteral">'unknown object type given to genobj: '</span>+val)
<a name="l00128"></a>00128                         env.Exit(1)
<a name="l00129"></a>00129 
<a name="l00130"></a><a class="code" href="classgeneric_1_1genobj.html#o0">00130</a>                 self.<a class="code" href="classgeneric_1_1genobj.html#o0">type</a>  = val
<a name="l00131"></a><a class="code" href="classgeneric_1_1genobj.html#o1">00131</a>                 self.<a class="code" href="classgeneric_1_1genobj.html#o1">orenv</a> = env
<a name="l00132"></a><a class="code" href="classgeneric_1_1genobj.html#o2">00132</a>                 self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>   = <span class="keywordtype">None</span>
<a name="l00133"></a><a class="code" href="classgeneric_1_1genobj.html#o3">00133</a>                 self.<a class="code" href="classgeneric_1_1genobj.html#o3">executed</a> = 0
<a name="l00134"></a>00134 
<a name="l00135"></a>00135                 <span class="comment">## list of source files </span>
<a name="l00136"></a>00136                 self.self.source=<span class="stringliteral">''</span>
<a name="l00137"></a>00137                 <span class="comment">## target name </span>
<a name="l00138"></a>00138                 self.self.target=<span class="stringliteral">''</span>
<a name="l00139"></a>00139 
<a name="l00140"></a>00140                 <span class="comment">## flags for c++ compiler (may be platform dependent)</span>
<a name="l00141"></a>00141                 self.self.cxxflags  =<span class="stringliteral">''</span>
<a name="l00142"></a>00142                 <span class="comment">## flags for c compiler (may be platform dependent)</span>
<a name="l00143"></a>00143                 self.self.ccflags   =<span class="stringliteral">''</span>
<a name="l00144"></a>00144                 <span class="comment">## additional include path(es) (using '/' on every platform)  </span>
<a name="l00145"></a>00145                 self.self.includes  =<span class="stringliteral">''</span>
<a name="l00146"></a>00146 
<a name="l00147"></a>00147                 <span class="comment">## flags for linker (may be platform dependent)</span>
<a name="l00148"></a>00148                 self.self.linkflags =<span class="stringliteral">''</span>
<a name="l00149"></a>00149                 <span class="comment">## list of path(es) containing required libraries (use with libs class member)</span>
<a name="l00150"></a>00150                 self.self.libpaths  =<span class="stringliteral">''</span>
<a name="l00151"></a>00151                 <span class="comment">## list of libraries which should be included in this binary object</span>
<a name="l00152"></a>00152                 <span class="comment"># use the basic library name without any platform specific prefix or suffixes </span>
<a name="l00153"></a>00153                 <span class="comment"># on linux e.g. use xyz for the real library named libxyz.so </span>
<a name="l00154"></a>00154                 self.self.libs      =<span class="stringliteral">''</span>
<a name="l00155"></a>00155 
<a name="l00156"></a>00156                 <span class="comment"># warning: uber-cool feature</span>
<a name="l00157"></a>00157                 <span class="comment"># self.uselib='KIO XML' and all linkflags, etc are added</span>
<a name="l00158"></a>00158                 
<a name="l00159"></a>00159                 <span class="comment">## use of bksys predefined module/libraries found in the configure part</span>
<a name="l00160"></a>00160                 <span class="comment"># This will add all required c/c++ and linker flags </span>
<a name="l00161"></a>00161                 <span class="comment"># often used modules are QT QTCORE QT3SUPPORT KDE4 FAM ART PCRE XML OPENSSL</span>
<a name="l00162"></a>00162                 self.self.uselib=<span class="stringliteral">''</span>
<a name="l00163"></a>00163 
<a name="l00164"></a>00164                 <span class="comment"># vars used by shlibs</span>
<a name="l00165"></a>00165                 self.self.vnum=<span class="stringliteral">''</span>
<a name="l00166"></a>00166                 <span class="comment">## library prefix </span>
<a name="l00167"></a>00167                 <span class="comment"># this value will be added at the beginning of the binary object target name </span>
<a name="l00168"></a>00168                 <span class="comment"># on linux e.g if the target is named \b xyaz and \b libprefix is set to \b 'lib' </span>
<a name="l00169"></a>00169                 <span class="comment"># the real library is named libxyz </span>
<a name="l00170"></a>00170                 self.self.libprefix=<span class="stringliteral">'lib'</span>
<a name="l00171"></a>00171 
<a name="l00172"></a>00172                 <span class="comment">## a directory where to install the targets (optional)</span>
<a name="l00173"></a>00173                 self.self.instdir=<span class="stringliteral">''</span>
<a name="l00174"></a>00174 
<a name="l00175"></a>00175                 <span class="comment"># change the working directory before reading the targets (do not use)</span>
<a name="l00176"></a>00176                 self.self.chdir=<span class="stringliteral">''</span>
<a name="l00177"></a>00177 
<a name="l00178"></a>00178                 <span class="comment">## unix permissions</span>
<a name="l00179"></a>00179                 self.self.perms=<span class="stringliteral">''</span>
<a name="l00180"></a>00180 
<a name="l00181"></a>00181                 <span class="comment"># these members are private</span>
<a name="l00182"></a>00182                 self.self.chdir_lock=<span class="keywordtype">None</span>
<a name="l00183"></a>00183                 self.self.dirprefix=<span class="stringliteral">'./'</span>
<a name="l00184"></a>00184                 self.self.old_os_dir=<span class="stringliteral">''</span>
<a name="l00185"></a>00185                 self.self.old_fs_dir=<span class="stringliteral">''</span>
<a name="l00186"></a>00186                 self.self.p_local_shlibs=[]
<a name="l00187"></a>00187                 self.self.p_local_staticlibs=[]
<a name="l00188"></a>00188                 self.self.p_global_shlibs=[]
<a name="l00189"></a>00189 
<a name="l00190"></a>00190                 self.self.p_localsource=<span class="keywordtype">None</span>
<a name="l00191"></a>00191                 self.self.p_localtarget=<span class="keywordtype">None</span>
<a name="l00192"></a>00192 
<a name="l00193"></a>00193                 <span class="comment"># work directory</span>
<a name="l00194"></a>00194                 self.self.workdir_lock=<span class="keywordtype">None</span>
<a name="l00195"></a>00195                 self.self.orig_fs_dir=SCons.Node.FS.default_fs.getcwd()
<a name="l00196"></a>00196                 self.self.not_orig_fs_dir=<span class="stringliteral">''</span>
<a name="l00197"></a>00197                 self.self.not_orig_os_dir=<span class="stringliteral">''</span>
<a name="l00198"></a>00198 
<a name="l00199"></a>00199                 <span class="comment"># with this it is not mandatory to call execute() on objects created ...</span>
<a name="l00200"></a>00200                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> env.has_key(<span class="stringliteral">'USE_THE_FORCE_LUKE'</span>): env[<span class="stringliteral">'USE_THE_FORCE_LUKE'</span>]=[self]
<a name="l00201"></a>00201                 <span class="keywordflow">else</span>: env[<span class="stringliteral">'USE_THE_FORCE_LUKE'</span>].append(self)
<a name="l00202"></a>00202 
<a name="l00203"></a>00203         <span class="comment"># called by subclasses to set the sources to compile</span>
<a name="l00204"></a><a class="code" href="classgeneric_1_1genobj.html#a0">00204</a>         <span class="keyword">def </span><a class="code" href="classgeneric_1_1genobj.html#a0">setsource</a>(self, src): self.p_localsource=self.<a class="code" href="classgeneric_1_1genobj.html#o1">orenv</a>.make_list(src)
<a name="l00205"></a>00205 
<a name="l00206"></a>00206         <span class="comment"># join the builddir to a path</span>
<a name="l00207"></a><a class="code" href="classgeneric_1_1genobj.html#a1">00207</a>         <span class="keyword">def </span><a class="code" href="classgeneric_1_1genobj.html#a1">joinpath</a>(self, val):
<a name="l00208"></a>00208                 <span class="keywordflow">if</span> len(self.self.dirprefix)&lt;3: <span class="keywordflow">return</span> val <span class="comment"># TODO - there can be a bug here ..</span>
<a name="l00209"></a>00209                 dir=self.self.dirprefix
<a name="l00210"></a>00210                 thing=self.<a class="code" href="classgeneric_1_1genobj.html#o1">orenv</a>.make_list(val)
<a name="l00211"></a>00211                 files=[]
<a name="l00212"></a>00212                 bdir=<span class="stringliteral">'./'</span>
<a name="l00213"></a>00213                 <span class="keywordflow">if</span> self.<a class="code" href="classgeneric_1_1genobj.html#o1">orenv</a>.has_key(<span class="stringliteral">'_BUILDDIR_'</span>): bdir=self.<a class="code" href="classgeneric_1_1genobj.html#o1">orenv</a>[<span class="stringliteral">'_BUILDDIR_'</span>]
<a name="l00214"></a>00214                 <span class="keywordflow">for</span> v <span class="keywordflow">in</span> thing: files.append( self.<a class="code" href="classgeneric_1_1genobj.html#o1">orenv</a>.join(bdir, dir, v) )
<a name="l00215"></a>00215                 <span class="keywordflow">return</span> files
<a name="l00216"></a>00216 
<a name="l00217"></a>00217         <span class="comment">## FIXME : this scheme is ugly (ita)</span>
<a name="l00218"></a>00218         <span class="comment"># a list of paths, with absolute and relative ones, useful when giving include dirs</span>
<a name="l00219"></a>00219         <span class="comment"># If a path begins with ##, then its corresponding build dir will be added as well</span>
<a name="l00220"></a><a class="code" href="classgeneric_1_1genobj.html#a2">00220</a>         <span class="keyword">def </span><a class="code" href="classgeneric_1_1genobj.html#a2">fixpath</a>(self, val):
<a name="l00221"></a>00221                 <span class="keyword">def </span>reldir(dir):
<a name="l00222"></a>00222                         ndir    = SCons.Node.FS.default_fs.Dir(dir).srcnode().abspath
<a name="l00223"></a>00223                         rootdir = SCons.Node.FS.default_fs.Dir(<span class="stringliteral">'#'</span>).abspath
<a name="l00224"></a>00224                         <span class="keywordflow">return</span> striproot(ndir.replace(rootdir, <span class="stringliteral">''</span>))
<a name="l00225"></a>00225 
<a name="l00226"></a>00226                 dir=self.self.dirprefix
<a name="l00227"></a>00227                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> len(dir)&gt;2: dir=reldir(<span class="stringliteral">'.'</span>)
<a name="l00228"></a>00228 
<a name="l00229"></a>00229                 thing=self.<a class="code" href="classgeneric_1_1genobj.html#o1">orenv</a>.make_list(val)
<a name="l00230"></a>00230                 ret=[]
<a name="l00231"></a>00231                 bdir=<span class="stringliteral">"./"</span>
<a name="l00232"></a>00232                 <span class="keywordflow">if</span> self.<a class="code" href="classgeneric_1_1genobj.html#o1">orenv</a>.has_key(<span class="stringliteral">'_BUILDDIR_'</span>): bdir=self.<a class="code" href="classgeneric_1_1genobj.html#o1">orenv</a>[<span class="stringliteral">'_BUILDDIR_'</span>]
<a name="l00233"></a>00233                 <span class="keywordflow">for</span> v <span class="keywordflow">in</span> thing:
<a name="l00234"></a>00234                         <span class="keywordflow">if</span> v[:2] == <span class="stringliteral">"##"</span>:
<a name="l00235"></a>00235                                 ret.append( self.<a class="code" href="classgeneric_1_1genobj.html#o1">orenv</a>.join(<span class="stringliteral">'#'</span>, bdir, v[2:]) )
<a name="l00236"></a>00236                                 v = v[1:]
<a name="l00237"></a>00237                                 
<a name="l00238"></a>00238                         <span class="keywordflow">if</span> v[:1] == <span class="stringliteral">"#"</span> <span class="keywordflow">or</span> v[:1] == <span class="stringliteral">"/"</span>:
<a name="l00239"></a>00239                                 ret.append(v)
<a name="l00240"></a>00240                         <span class="keywordflow">else</span>:
<a name="l00241"></a>00241                                 ret.append( self.<a class="code" href="classgeneric_1_1genobj.html#o1">orenv</a>.join(<span class="stringliteral">'#'</span>, bdir, dir, v) )
<a name="l00242"></a>00242                                 ret.append( self.<a class="code" href="classgeneric_1_1genobj.html#o1">orenv</a>.join(<span class="stringliteral">'#'</span>, dir, v) )
<a name="l00243"></a>00243 
<a name="l00244"></a>00244                 <span class="keywordflow">return</span> ret
<a name="l00245"></a>00245 
<a name="l00246"></a><a class="code" href="classgeneric_1_1genobj.html#a3">00246</a>         <span class="keyword">def </span><a class="code" href="classgeneric_1_1genobj.html#a3">lockworkdir</a>(self):
<a name="l00247"></a>00247                 <span class="keywordflow">if</span> self.self.workdir_lock: <span class="keywordflow">return</span>
<a name="l00248"></a>00248                 self.self.workdir_lock=1
<a name="l00249"></a>00249                 self.self.not_orig_fs_dir=SCons.Node.FS.default_fs.getcwd()
<a name="l00250"></a>00250                 self.self.not_orig_os_dir=os.getcwd()
<a name="l00251"></a>00251                 SCons.Node.FS.default_fs.chdir( self.self.orig_fs_dir, change_os_dir=1)
<a name="l00252"></a>00252 
<a name="l00253"></a><a class="code" href="classgeneric_1_1genobj.html#a4">00253</a>         <span class="keyword">def </span><a class="code" href="classgeneric_1_1genobj.html#a4">unlockworkdir</a>(self):
<a name="l00254"></a>00254                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.self.workdir_lock: <span class="keywordflow">return</span>
<a name="l00255"></a>00255                 SCons.Node.FS.default_fs.chdir( self.self.not_orig_fs_dir, change_os_dir=0)
<a name="l00256"></a>00256                 os.chdir(self.self.not_orig_os_dir)
<a name="l00257"></a>00257                 self.self.workdir_lock=<span class="keywordtype">None</span>
<a name="l00258"></a>00258 
<a name="l00259"></a><a class="code" href="classgeneric_1_1genobj_1_1WrongLibError.html">00259</a>         <span class="keyword">class </span><a class="code" href="classgeneric_1_1genobj_1_1WrongLibError.html">WrongLibError</a>(Exception):
<a name="l00260"></a>00260                 <span class="keyword">def </span>__init__(self, value):
<a name="l00261"></a><a class="code" href="classgeneric_1_1genobj_1_1WrongLibError.html#o0">00261</a>                         self.<a class="code" href="classgeneric_1_1genobj_1_1WrongLibError.html#o0">value</a> = value
<a name="l00262"></a>00262                 
<a name="l00263"></a>00263                 <span class="keyword">def </span>__str__(self):
<a name="l00264"></a>00264                         <span class="keywordflow">return</span> <span class="stringliteral">"No such library "</span> + self.<a class="code" href="classgeneric_1_1genobj_1_1WrongLibError.html#o0">value</a>
<a name="l00265"></a>00265 
<a name="l00266"></a>00266         <span class="comment">## When an object is created and the sources, targets, etc are given</span>
<a name="l00267"></a>00267         <span class="comment"># the execute command calls the SCons functions like Program, Library, etc</span>
<a name="l00268"></a><a class="code" href="classgeneric_1_1genobj.html#a5">00268</a>         <span class="keyword">def </span><a class="code" href="classgeneric_1_1genobj.html#a5">execute</a>(self):
<a name="l00269"></a>00269                 <span class="keywordflow">if</span> self.<a class="code" href="classgeneric_1_1genobj.html#o3">executed</a>: <span class="keywordflow">return</span>
<a name="l00270"></a>00270 
<a name="l00271"></a>00271                 <span class="comment"># dump the configuration to xml when asked to</span>
<a name="l00272"></a>00272                 <span class="keywordflow">if</span> self.<a class="code" href="classgeneric_1_1genobj.html#o1">orenv</a>.has_key(<span class="stringliteral">'DUMPCONFIG'</span>):
<a name="l00273"></a>00273                         self.self.xml()
<a name="l00274"></a>00274                         self.<a class="code" href="classgeneric_1_1genobj.html#o3">executed</a>=1
<a name="l00275"></a>00275                         <span class="keywordflow">return</span>
<a name="l00276"></a>00276 
<a name="l00277"></a>00277                 <span class="comment"># copy the environment if a subclass has not already done it</span>
<a name="l00278"></a>00278                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>: self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a> = self.<a class="code" href="classgeneric_1_1genobj.html#o1">orenv</a>.Copy()
<a name="l00279"></a>00279 
<a name="l00280"></a>00280                 <span class="comment"># remove libprefix is one is given to avoid repeated libprefix</span>
<a name="l00281"></a>00281                 <span class="keywordflow">if</span> self.self.libprefix != <span class="stringliteral">''</span> <span class="keywordflow">and</span> self.self.target[:len(self.self.libprefix)] == self.self.libprefix:
<a name="l00282"></a>00282                         self.self.target = self.self.target[len(self.self.libprefix):]
<a name="l00283"></a>00283 
<a name="l00284"></a>00284                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.self.p_localtarget: self.self.p_localtarget = self.<a class="code" href="classgeneric_1_1genobj.html#a1">joinpath</a>(self.self.target)
<a name="l00285"></a>00285                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.self.p_localsource: self.self.p_localsource = self.<a class="code" href="classgeneric_1_1genobj.html#a1">joinpath</a>(self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.make_list(self.self.source))
<a name="l00286"></a>00286 
<a name="l00287"></a>00287                 <span class="keywordflow">if</span> (<span class="keywordflow">not</span> self.self.source <span class="keywordflow">or</span> len(self.self.source) == 0) <span class="keywordflow">and</span> <span class="keywordflow">not</span> self.self.p_localsource:
<a name="l00288"></a>00288                         self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.pprint(<span class="stringliteral">'RED'</span>,<span class="stringliteral">"no source file given to object - self.source for "</span>+self.self.target)
<a name="l00289"></a>00289                         self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.Exit(1)
<a name="l00290"></a>00290 
<a name="l00291"></a>00291                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.self.target:
<a name="l00292"></a>00292                         self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.pprint(<span class="stringliteral">'RED'</span>,<span class="stringliteral">"no target given to object - self.target"</span>)
<a name="l00293"></a>00293                         self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.Exit(1)
<a name="l00294"></a>00294                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.has_key(<span class="stringliteral">'nosmart_includes'</span>):
<a name="l00295"></a>00295                         self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.AppendUnique(CPPPATH=[<span class="stringliteral">'.'</span>, self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.join(<span class="stringliteral">'#'</span>,self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>[<span class="stringliteral">'_BUILDDIR_'</span>]) ])
<a name="l00296"></a>00296                 <span class="keywordflow">if</span> self.<a class="code" href="classgeneric_1_1genobj.html#o0">type</a> == <span class="stringliteral">"kioslave"</span>: self.self.libprefix=<span class="stringliteral">''</span>
<a name="l00297"></a>00297 
<a name="l00298"></a>00298                 <span class="keywordflow">if</span> len(self.self.includes)&gt;0: self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.AppendUnique(CPPPATH=self.<a class="code" href="classgeneric_1_1genobj.html#a2">fixpath</a>(self.self.includes))
<a name="l00299"></a>00299                 <span class="keywordflow">if</span> len(self.self.cxxflags)&gt;0: self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.AppendUnique(CXXFLAGS=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.make_list(self.self.cxxflags))
<a name="l00300"></a>00300                 <span class="keywordflow">if</span> len(self.self.ccflags)&gt;0: self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.AppendUnique(CCFLAGS=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.make_list(self.self.ccflags))
<a name="l00301"></a>00301 
<a name="l00302"></a>00302                 <span class="keywordflow">if</span> self.<a class="code" href="classgeneric_1_1genobj.html#o0">type</a>==<span class="stringliteral">'convenience'</span>:
<a name="l00303"></a>00303                         self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.AppendUnique(CCFLAGS=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>[<span class="stringliteral">'CONVENIENCE'</span>],CXXFLAGS=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>[<span class="stringliteral">'CONVENIENCE'</span>])
<a name="l00304"></a>00304 
<a name="l00305"></a>00305                 <span class="comment"># add the libraries given directly</span>
<a name="l00306"></a>00306                 llist=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.make_list(self.self.libs)
<a name="l00307"></a>00307                 <span class="keywordflow">if</span> self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>[<span class="stringliteral">'WINDOWS'</span>]:
<a name="l00308"></a>00308                         lext=[<span class="stringliteral">'.la'</span>]
<a name="l00309"></a>00309                 <span class="keywordflow">else</span>:
<a name="l00310"></a>00310                         lext=[<span class="stringliteral">'.so'</span>, <span class="stringliteral">'.la'</span>, <span class="stringliteral">'.dylib'</span>,<span class="stringliteral">'.dll'</span>]
<a name="l00311"></a>00311                 sext=[<span class="stringliteral">'.a'</span>]
<a name="l00312"></a>00312                 <span class="keywordflow">for</span> lib <span class="keywordflow">in</span> llist:
<a name="l00313"></a>00313                         sal=SCons.Util.splitext(lib)
<a name="l00314"></a>00314                         <span class="comment"># FIXME: uuuuugly!  What's a better way to handle this?  It will get unwieldy for platform-specific stuff soon</span>
<a name="l00315"></a>00315                         <span class="comment"># maybe find a way to read qmake.conf and decide what the libraries look like based on CONFIG = lib_version_first ?</span>
<a name="l00316"></a>00316                         <span class="comment"># also really need to handle libsuffix better</span>
<a name="l00317"></a>00317                         <span class="keywordflow">if</span> len(sal)&gt;1:
<a name="l00318"></a>00318                                 <span class="keywordflow">if</span> (sal[-1] <span class="keywordflow">in</span> lext) <span class="keywordflow">and</span> (sys.platform == <span class="stringliteral">'darwin'</span>): 
<a name="l00319"></a>00319                                         self.self.p_local_shlibs.append(self.<a class="code" href="classgeneric_1_1genobj.html#a2">fixpath</a>(sal[0]+<span class="stringliteral">'.dylib'</span>)[0]);
<a name="l00320"></a>00320                                 <span class="keywordflow">elif</span> (sal[1] <span class="keywordflow">in</span> lext) <span class="keywordflow">and</span> (sys.platform != <span class="stringliteral">'darwin'</span>): 
<a name="l00321"></a>00321                                         <span class="keywordflow">print</span> <span class="stringliteral">"shared lib "</span> + lib
<a name="l00322"></a>00322                                         <span class="keywordflow">if</span> env[<span class="stringliteral">'WINDOWS'</span>]:
<a name="l00323"></a>00323                                                 self.self.p_local_shlibs.append(self.<a class="code" href="classgeneric_1_1genobj.html#a2">fixpath</a>(sal[0]+<span class="stringliteral">'.la'</span>)[0])
<a name="l00324"></a>00324                                         <span class="keywordflow">else</span>:
<a name="l00325"></a>00325                                                 self.self.p_local_shlibs.append(self.<a class="code" href="classgeneric_1_1genobj.html#a2">fixpath</a>(sal[0]+<span class="stringliteral">'.so'</span>)[0])
<a name="l00326"></a>00326                                 <span class="keywordflow">elif</span> sal[1] <span class="keywordflow">in</span> sext: 
<a name="l00327"></a>00327                                         self.self.p_local_staticlibs.append(self.<a class="code" href="classgeneric_1_1genobj.html#a2">fixpath</a>(sal[0]+<span class="stringliteral">'.a'</span>)[0])
<a name="l00328"></a>00328                                         <span class="keywordflow">print</span> <span class="stringliteral">"added static lib "</span> + lib
<a name="l00329"></a>00329                                 <span class="keywordflow">else</span>: 
<a name="l00330"></a>00330                                         <span class="comment"># where can i get a list of all available libraries ? </span>
<a name="l00331"></a>00331                                         <span class="comment"># In that list the real given name should be lookuped and that path/name </span>
<a name="l00332"></a>00332                                         <span class="comment"># should be added to the library list. </span>
<a name="l00333"></a>00333                                         <span class="comment"># Another very time consuming approach would be to search all given </span>
<a name="l00334"></a>00334                                         <span class="comment"># libpaths for mostly used common library name -&gt; very time consuming  </span>
<a name="l00335"></a>00335 
<a name="l00336"></a>00336 <span class="comment">#                                       self.p_local_shlibs.append(self.fixpath(self.libprefix+lib+'.la')[0])</span>
<a name="l00337"></a>00337 <span class="comment">#                                       self.p_global_shlibs.append(lib)</span>
<a name="l00338"></a>00338                                         <span class="keywordflow">print</span> <span class="stringliteral">"added global lib "</span> + lib
<a name="l00339"></a>00339 
<a name="l00340"></a>00340                 <span class="comment"># and now add the libraries from uselib</span>
<a name="l00341"></a>00341                 <span class="keywordflow">if</span> self.self.uselib:
<a name="l00342"></a>00342                         libs=SCons.Util.CLVar(self.self.uselib)
<a name="l00343"></a>00343                         <span class="keywordflow">for</span> lib <span class="keywordflow">in</span> libs:
<a name="l00344"></a>00344                                 <span class="comment"># TODO: this doesn't work if the lib doesn't exist (eg, FAM on Mac OS X), we need to handle optional libraries nicely</span>
<a name="l00345"></a>00345                                 <span class="comment">#if not self.env.has_key('LIBPATH_'+lib) and not self.env.has_key('INCLUDES_'+lib) and not self.env.has_key('LIB_'+lib) and not self.env.has_key('LINKFLAGS_'+lib):</span>
<a name="l00346"></a>00346                                 <span class="comment">#       raise genobj.WrongLibError(lib)</span>
<a name="l00347"></a>00347                                 <span class="keywordflow">if</span> self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.has_key(<span class="stringliteral">'FRAMEWORK_'</span>+lib):
<a name="l00348"></a>00348                                         self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.AppendUnique(FRAMEWORKS=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>[<span class="stringliteral">'FRAMEWORK_'</span>+lib])
<a name="l00349"></a>00349                                 <span class="keywordflow">elif</span> self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.has_key(<span class="stringliteral">'LIB_'</span>+lib):
<a name="l00350"></a>00350                                         self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.AppendUnique(LIBS=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>[<span class="stringliteral">'LIB_'</span>+lib])
<a name="l00351"></a>00351                                 <span class="keywordflow">if</span> self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.has_key(<span class="stringliteral">'FRAMEWORKPATH_'</span>+lib):
<a name="l00352"></a>00352                                         self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.AppendUnique(FRAMEWORKPATH=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>[<span class="stringliteral">'FRAMEWORKPATH_'</span>+lib])
<a name="l00353"></a>00353                                 <span class="keywordflow">elif</span> self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.has_key(<span class="stringliteral">'LIBPATH_'</span>+lib):
<a name="l00354"></a>00354                                         self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.AppendUnique(LIBPATH=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>[<span class="stringliteral">'LIBPATH_'</span>+lib])
<a name="l00355"></a>00355                                 <span class="keywordflow">if</span> self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.has_key(<span class="stringliteral">'LINKFLAGS_'</span>+lib):
<a name="l00356"></a>00356                                         self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.AppendUnique(LINKFLAGS=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>[<span class="stringliteral">'LINKFLAGS_'</span>+lib])
<a name="l00357"></a>00357                                 <span class="keywordflow">if</span> self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.has_key(<span class="stringliteral">'INCLUDES_'</span>+lib):
<a name="l00358"></a>00358                                         self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.AppendUnique(CPPPATH=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>[<span class="stringliteral">'INCLUDES_'</span>+lib])
<a name="l00359"></a>00359                                 <span class="keywordflow">if</span> self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.has_key(<span class="stringliteral">'CXXFLAGS_'</span>+lib):
<a name="l00360"></a>00360                                         self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.AppendUnique(CXXFLAGS=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>[<span class="stringliteral">'CXXFLAGS_'</span>+lib])
<a name="l00361"></a>00361                                 <span class="keywordflow">if</span> self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.has_key(<span class="stringliteral">'CCFLAGS_'</span>+lib):
<a name="l00362"></a>00362                                         self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.AppendUnique(CCFLAGS=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>[<span class="stringliteral">'CCFLAGS_'</span>+lib])
<a name="l00363"></a>00363                                 <span class="keywordflow">if</span> self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.has_key(<span class="stringliteral">'CPPPATH_'</span>+lib):
<a name="l00364"></a>00364                                         self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.AppendUnique(CPPPATH=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>[<span class="stringliteral">'CPPPATH_'</span>+lib])
<a name="l00365"></a>00365                                 <span class="keywordflow">if</span> self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.has_key(<span class="stringliteral">'RPATH_'</span>+lib) <span class="keywordflow">and</span> self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>[<span class="stringliteral">'_WANT_RPATH_'</span>]:
<a name="l00366"></a>00366                                         self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.AppendUnique(RPATH=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>[<span class="stringliteral">'RPATH_'</span>+lib])
<a name="l00367"></a>00367 
<a name="l00368"></a>00368                 <span class="comment"># Settings for static and shared libraries</span>
<a name="l00369"></a>00369                 <span class="keywordflow">if</span> len(self.self.libpaths)&gt;0:           self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.PrependUnique(LIBPATH=self.<a class="code" href="classgeneric_1_1genobj.html#a2">fixpath</a>(self.self.libpaths))
<a name="l00370"></a>00370                 <span class="keywordflow">if</span> len(self.self.linkflags)&gt;0:          self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.PrependUnique(LINKFLAGS=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.make_list(self.self.linkflags))
<a name="l00371"></a>00371                 <span class="keywordflow">if</span> len(self.self.p_local_staticlibs)&gt;0: self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.link_local_staticlib(self.self.p_local_staticlibs)
<a name="l00372"></a>00372                 <span class="keywordflow">if</span> len(self.self.p_local_shlibs)&gt;0:     self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.link_local_shlib(self.self.p_local_shlibs)
<a name="l00373"></a>00373                 <span class="keywordflow">if</span> len(self.self.p_global_shlibs)&gt;0:    self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.AppendUnique(LIBS=self.self.p_global_shlibs)
<a name="l00374"></a>00374                 <span class="comment"># The target to return - IMPORTANT no more self.env modification is possible after this part</span>
<a name="l00375"></a>00375                 ret=<span class="keywordtype">None</span>
<a name="l00376"></a>00376                 <span class="keywordflow">if</span> self.<a class="code" href="classgeneric_1_1genobj.html#o0">type</a>==<span class="stringliteral">'shlib'</span> <span class="keywordflow">or</span> self.<a class="code" href="classgeneric_1_1genobj.html#o0">type</a>==<span class="stringliteral">'kioslave'</span> <span class="keywordflow">or</span> self.<a class="code" href="classgeneric_1_1genobj.html#o0">type</a>==<span class="stringliteral">'module'</span>:
<a name="l00377"></a>00377                         ret=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.bksys_shlib(self.self.p_localtarget, self.self.p_localsource, self.self.instdir, 
<a name="l00378"></a>00378                                 self.self.libprefix, self.self.vnum)
<a name="l00379"></a>00379                 <span class="keywordflow">elif</span> self.<a class="code" href="classgeneric_1_1genobj.html#o0">type</a>==<span class="stringliteral">'program'</span>:
<a name="l00380"></a>00380                         ret=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.Program(self.self.p_localtarget, self.self.p_localsource)
<a name="l00381"></a>00381                         <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.has_key(<span class="stringliteral">'NOAUTOINSTALL'</span>) <span class="keywordflow">and</span> self.self.instdir:
<a name="l00382"></a>00382                                 ins=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.bksys_install(self.self.instdir, ret, perms=self.self.perms)
<a name="l00383"></a>00383                 <span class="keywordflow">elif</span> self.<a class="code" href="classgeneric_1_1genobj.html#o0">type</a>==<span class="stringliteral">'staticlib'</span> <span class="keywordflow">or</span> self.<a class="code" href="classgeneric_1_1genobj.html#o0">type</a>==<span class="stringliteral">'convenience'</span>:
<a name="l00384"></a>00384                         ret=self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.StaticLibrary(self.self.p_localtarget, self.self.p_localsource)
<a name="l00385"></a>00385 
<a name="l00386"></a>00386                 <span class="comment"># If we link the program against a shared library made locally, add the dependency</span>
<a name="l00387"></a>00387                 <span class="keywordflow">if</span> len(self.self.p_local_shlibs)&gt;0:
<a name="l00388"></a>00388                         <span class="keywordflow">if</span> ret: self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.Depends( ret, self.self.p_local_shlibs )
<a name="l00389"></a>00389                 <span class="keywordflow">if</span> len(self.self.p_local_staticlibs)&gt;0:
<a name="l00390"></a>00390                         <span class="keywordflow">if</span> ret: self.<a class="code" href="classgeneric_1_1genobj.html#o2">env</a>.Depends( ret, self.self.p_local_staticlibs )
<a name="l00391"></a>00391 
<a name="l00392"></a>00392                 self.<a class="code" href="classgeneric_1_1genobj.html#o3">executed</a>=1
<a name="l00393"></a>00393 
<a name="l00394"></a>00394 <span class="comment">## install files given named resources, for example KDEBIN to install stuff with kde binaries</span>
<a name="l00395"></a><a class="code" href="namespacegeneric.html#a25">00395</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a25">getInstDirForResType</a>(lenv,restype):
<a name="l00396"></a>00396         <span class="keywordflow">if</span> len(restype) == 0 <span class="keywordflow">or</span> <span class="keywordflow">not</span> lenv.has_key(restype):
<a name="l00397"></a>00397                 lenv.pprint(<span class="stringliteral">'RED'</span>,<span class="stringliteral">"unknown resource type "</span>+restype)
<a name="l00398"></a>00398                 lenv.Exit(1)
<a name="l00399"></a>00399         <span class="keywordflow">else</span>: instdir = lenv[restype]
<a name="l00400"></a>00400         <span class="keywordflow">if</span> lenv[<span class="stringliteral">'ARGS'</span>] <span class="keywordflow">and</span> lenv[<span class="stringliteral">'ARGS'</span>].has_key(<span class="stringliteral">'prefix'</span>):
<a name="l00401"></a>00401                 instdir = instdir.replace(lenv[<span class="stringliteral">'PREFIX'</span>], lenv[<span class="stringliteral">'ARGS'</span>][<span class="stringliteral">'prefix'</span>])
<a name="l00402"></a>00402         <span class="keywordflow">return</span> instdir
<a name="l00403"></a>00403 
<a name="l00404"></a>00404 <span class="comment">## HELPER Expands strings given and make sure to return a list type</span>
<a name="l00405"></a>00405 <span class="comment">## TODO: get rid of it (ita)</span>
<a name="l00406"></a><a class="code" href="namespacegeneric.html#a26">00406</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a26">make_list</a>(env, s):
<a name="l00407"></a>00407         <span class="keywordflow">if</span> type(s) <span class="keywordflow">is</span> types.ListType: <span class="keywordflow">return</span> s
<a name="l00408"></a>00408         <span class="keywordflow">else</span>:
<a name="l00409"></a>00409                 <span class="keywordflow">try</span>: <span class="keywordflow">return</span> s.split()
<a name="l00410"></a>00410                 <span class="keywordflow">except</span> AttributeError: <span class="keywordflow">return</span> s
<a name="l00411"></a>00411 
<a name="l00412"></a>00412 <span class="comment">## HELPER - replace current os path separators with slashes</span>
<a name="l00413"></a><a class="code" href="namespacegeneric.html#a27">00413</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a27">slashify</a>(val):
<a name="l00414"></a>00414         <span class="keywordflow">if</span> os.sep == <span class="stringliteral">"\\"</span>:
<a name="l00415"></a>00415                 <span class="keywordflow">return</span> str.replace(val,os.sep,<span class="stringliteral">'/'</span>)
<a name="l00416"></a>00416         <span class="keywordflow">else</span>:
<a name="l00417"></a>00417                 <span class="keywordflow">return</span> val
<a name="l00418"></a>00418         
<a name="l00419"></a>00419 <span class="comment">## HELPER - strip root '/' from path</span>
<a name="l00420"></a><a class="code" href="namespacegeneric.html#a28">00420</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a28">striproot</a>(s):
<a name="l00421"></a>00421         a = string.lstrip(s)
<a name="l00422"></a>00422         <span class="comment"># TODO add win32 support </span>
<a name="l00423"></a>00423         <span class="keywordflow">if</span> a[0] == os.sep:
<a name="l00424"></a>00424                 <span class="keywordflow">return</span> a[1:]
<a name="l00425"></a>00425         <span class="keywordflow">else</span>:
<a name="l00426"></a>00426                 <span class="keywordflow">return</span> a
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 <span class="comment">## HELPER - join pathes </span>
<a name="l00429"></a><a class="code" href="namespacegeneric.html#a29">00429</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a29">join</a>(lenv, s1, s2, s3=None, s4=None):
<a name="l00430"></a>00430         <span class="keywordflow">if</span> s4 <span class="keywordflow">and</span> s3: <span class="keywordflow">return</span> lenv.join(s1, s2, lenv.join(s3, s4))
<a name="l00431"></a>00431         <span class="keywordflow">if</span> s3 <span class="keywordflow">and</span> s2: <span class="keywordflow">return</span> lenv.join(s1, lenv.join(s2, s3))
<a name="l00432"></a>00432         <span class="keywordflow">elif</span> <span class="keywordflow">not</span> s2:  <span class="keywordflow">return</span> s1
<a name="l00433"></a>00433         <span class="comment"># having s1, s2</span>
<a name="l00434"></a>00434         <span class="comment">#print "path1 is "+s1+" path2 is "+s2+" "+os.path.join(s1,striproot(s2))</span>
<a name="l00435"></a>00435         <span class="keywordflow">if</span> <span class="keywordflow">not</span> s1: s1=os.sep 
<a name="l00436"></a>00436         <span class="keywordflow">return</span> os.path.join(s1,striproot(s2))
<a name="l00437"></a>00437 
<a name="l00438"></a>00438 <span class="comment">## HELPER export the data to xml</span>
<a name="l00439"></a>00439 bks_dump=<span class="stringliteral">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;\n&lt;bksys version="1"&gt;\n'</span>
<a name="l00440"></a><a class="code" href="namespacegeneric.html#a30">00440</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a30">add_dump</a>(nenv, str):
<a name="l00441"></a>00441         <span class="keyword">global</span> bks_dump
<a name="l00442"></a>00442         <span class="keywordflow">if</span> str: bks_dump+=str
<a name="l00443"></a><a class="code" href="namespacegeneric.html#a31">00443</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a31">get_dump</a>(nenv):
<a name="l00444"></a>00444         <span class="keywordflow">if</span> <span class="keywordflow">not</span> nenv.has_key(<span class="stringliteral">'DUMPCONFIG'</span>):
<a name="l00445"></a>00445                 nenv.pprint(<span class="stringliteral">'RED'</span>,<span class="stringliteral">'WARNING: trying to get a dump while DUMPCONFIG is not set - this will not work'</span>)
<a name="l00446"></a>00446         <span class="keyword">global</span> bks_dump
<a name="l00447"></a>00447         <span class="keywordflow">return</span> bks_dump+<span class="stringliteral">"&lt;/bksys&gt;\n"</span>
<a name="l00448"></a>00448 
<a name="l00449"></a>00449 <span class="comment">## HELPER - is used by the xml stuff in pmanager (ignore for now)</span>
<a name="l00450"></a><a class="code" href="namespacegeneric.html#a32">00450</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a32">getreldir</a>(lenv):
<a name="l00451"></a>00451         cwd=os.getcwd()
<a name="l00452"></a>00452         root=SCons.Node.FS.default_fs.Dir(<span class="stringliteral">'#'</span>).abspath
<a name="l00453"></a>00453         <span class="keywordflow">return</span> striproot(cwd.replace(root,<span class="stringliteral">''</span>))
<a name="l00454"></a>00454 
<a name="l00455"></a>00455 <span class="comment">## HELPER - find programs and headers</span>
<a name="l00456"></a><a class="code" href="namespacegeneric.html#a33">00456</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a33">find_path</a>(lenv, file, path_list):
<a name="l00457"></a>00457         <span class="keywordflow">for</span> dir <span class="keywordflow">in</span> path_list:
<a name="l00458"></a>00458                 <span class="keywordflow">if</span> os.path.exists( lenv.join(dir, file) ):
<a name="l00459"></a>00459                         <span class="keywordflow">return</span> dir
<a name="l00460"></a>00460         <span class="keywordflow">return</span> <span class="stringliteral">''</span>
<a name="l00461"></a>00461 
<a name="l00462"></a><a class="code" href="namespacegeneric.html#a34">00462</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a34">find_file</a>(lenv, file, path_list):
<a name="l00463"></a>00463         <span class="keywordflow">for</span> dir <span class="keywordflow">in</span> path_list:
<a name="l00464"></a>00464                 <span class="keywordflow">if</span> os.path.exists( lenv.join(dir, file) ):
<a name="l00465"></a>00465                         <span class="keywordflow">return</span> lenv.join(dir, file)
<a name="l00466"></a>00466         <span class="keywordflow">return</span> <span class="stringliteral">''</span>
<a name="l00467"></a>00467 
<a name="l00468"></a><a class="code" href="namespacegeneric.html#a35">00468</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a35">find_program</a>(lenv, file, path_list):
<a name="l00469"></a>00469         <span class="keywordflow">if</span> lenv[<span class="stringliteral">'WINDOWS'</span>]:
<a name="l00470"></a>00470                 file += <span class="stringliteral">'.exe'</span>
<a name="l00471"></a>00471         <span class="keywordflow">for</span> dir <span class="keywordflow">in</span> path_list:
<a name="l00472"></a>00472                 <span class="keywordflow">if</span> os.path.exists( lenv.join(dir, file) ):
<a name="l00473"></a>00473                         <span class="keywordflow">return</span> lenv.join(dir, file)
<a name="l00474"></a>00474         <span class="keywordflow">return</span> <span class="stringliteral">''</span>
<a name="l00475"></a>00475 
<a name="l00476"></a><a class="code" href="namespacegeneric.html#a36">00476</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a36">find_program_using_which</a>(lenv, prog):
<a name="l00477"></a>00477         <span class="keywordflow">if</span> lenv[<span class="stringliteral">'WINDOWS'</span>]: <span class="comment"># we're not depending on Cygwin</span>
<a name="l00478"></a>00478                 <span class="keywordflow">return</span> <span class="stringliteral">''</span>
<a name="l00479"></a>00479         <span class="keywordflow">return</span> os.popen(<span class="stringliteral">"which %s 2&gt;/dev/null"</span> % prog).read().strip()
<a name="l00480"></a>00480 
<a name="l00481"></a>00481 <span class="comment">## Scons-specific function, do not remove</span>
<a name="l00482"></a><a class="code" href="namespacegeneric.html#a37">00482</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a37">exists</a>(env):
<a name="l00483"></a>00483         <span class="keywordflow">return</span> true
<a name="l00484"></a>00484 
<a name="l00485"></a>00485 <span class="comment">## get the compiler to use from the command line or from QMAKESPEC</span>
<a name="l00486"></a>00486 <span class="comment">## this is needed for environments with more than one compiler installed</span>
<a name="l00487"></a>00487 <span class="comment">## or when you want to cross-compile (don't forget to set PLATFORM correct - not ready)</span>
<a name="l00488"></a><a class="code" href="namespacegeneric.html#a38">00488</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a38">getCompiler</a>(env,sys):
<a name="l00489"></a>00489         <span class="comment">#cached value</span>
<a name="l00490"></a>00490         <span class="keywordflow">if</span> env.has_key(<span class="stringliteral">'COMPILERTOOL'</span>):
<a name="l00491"></a>00491                 <span class="keywordflow">return</span> env[<span class="stringliteral">'COMPILERTOOL'</span>]
<a name="l00492"></a>00492 
<a name="l00493"></a>00493         <span class="keywordflow">if</span> env[<span class="stringliteral">'ARGS'</span>] <span class="keywordflow">and</span> env[<span class="stringliteral">'ARGS'</span>].has_key(<span class="stringliteral">'platform'</span>):
<a name="l00494"></a>00494                 <span class="comment"># first check for argument 'platform'</span>
<a name="l00495"></a>00495                 platform = env[<span class="stringliteral">'ARGS'</span>][<span class="stringliteral">'platform'</span>]
<a name="l00496"></a>00496         <span class="keywordflow">elif</span> os.environ.has_key(<span class="stringliteral">'QMAKESPEC'</span>):
<a name="l00497"></a>00497                 <span class="comment"># the look for QMAKESPEC</span>
<a name="l00498"></a>00498                 platform = os.environ[<span class="stringliteral">'QMAKESPEC'</span>]
<a name="l00499"></a>00499         <span class="keywordflow">else</span>:
<a name="l00500"></a>00500         <span class="comment"># nothing set - use the best SCons finds</span>
<a name="l00501"></a>00501                 <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00502"></a>00502 
<a name="l00503"></a>00503         regex = re.compile(<span class="stringliteral">'^(.+)-(.+)$'</span>, re.IGNORECASE)
<a name="l00504"></a>00504         match = regex.search(platform)
<a name="l00505"></a>00505         <span class="keywordflow">if</span> match:
<a name="l00506"></a>00506                 plat = match.group(1)
<a name="l00507"></a>00507                 comp = match.group(2)
<a name="l00508"></a>00508                 <span class="keywordflow">if</span> plat == <span class="stringliteral">'win32'</span>:
<a name="l00509"></a>00509                         <span class="keywordflow">if</span> comp == <span class="stringliteral">'msvc.net'</span> <span class="keywordflow">or</span> comp == <span class="stringliteral">'msvc2005'</span>:
<a name="l00510"></a>00510                                 <span class="keywordflow">return</span> <span class="stringliteral">'msvc'</span>       <span class="comment"># tool name is msvc</span>
<a name="l00511"></a>00511                         <span class="keywordflow">if</span> comp == <span class="stringliteral">'g++'</span>:
<a name="l00512"></a>00512                                 <span class="keywordflow">return</span> <span class="stringliteral">'mingw'</span>
<a name="l00513"></a>00513                         <span class="comment"># if comp == 'msvc':    # not supported</span>
<a name="l00514"></a>00514                 <span class="keywordflow">elif</span> plat == <span class="stringliteral">'linux'</span>:
<a name="l00515"></a>00515                         <span class="keywordflow">return</span> <span class="keyword">False</span>            <span class="comment"># for now</span>
<a name="l00516"></a>00516                 <span class="keywordflow">elif</span> plat == <span class="stringliteral">'macx'</span>:
<a name="l00517"></a>00517                         <span class="keywordflow">return</span> <span class="keyword">False</span>            <span class="comment"># for now</span>
<a name="l00518"></a>00518                 env.pprint(<span class="stringliteral">'RED'</span>, <span class="stringliteral">'platform '</span>+platform+<span class="stringliteral">' currently not supported'</span>)
<a name="l00519"></a>00519                 env.Exit(1)
<a name="l00520"></a>00520         <span class="keywordflow">else</span>:
<a name="l00521"></a>00521                 env.pprint(<span class="stringliteral">'YELLOW'</span>, <span class="stringliteral">'could not parse '</span>+platform)
<a name="l00522"></a>00522         <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00523"></a>00523 
<a name="l00524"></a>00524 <span class="comment">## Entry point of the module generic</span>
<a name="l00525"></a><a class="code" href="namespacegeneric.html#a39">00525</a> <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a39">generate</a>(env):
<a name="l00526"></a>00526 
<a name="l00527"></a>00527         <span class="comment">## (added by Coolo apparently)</span>
<a name="l00528"></a>00528         <span class="comment">## i see what it does now - however importing default tools causes performance issues (TODO ita)</span>
<a name="l00529"></a>00529         <span class="keyword">from</span> SCons.Tool <span class="keyword">import</span> Tool;
<a name="l00530"></a>00530         Tool(<span class="stringliteral">'default'</span>).generate(env)
<a name="l00531"></a>00531 
<a name="l00532"></a>00532         <span class="keywordflow">if</span> env[<span class="stringliteral">'PLATFORM'</span>] <span class="keywordflow">in</span> (<span class="stringliteral">'cygwin'</span>, <span class="stringliteral">'mingw'</span>, <span class="stringliteral">'win32'</span>, <span class="stringliteral">'win64'</span>):
<a name="l00533"></a>00533                 env[<span class="stringliteral">'WINDOWS'</span>]=1
<a name="l00534"></a>00534         <span class="keywordflow">else</span>:
<a name="l00535"></a>00535                 env[<span class="stringliteral">'WINDOWS'</span>]=0
<a name="l00536"></a>00536 
<a name="l00537"></a>00537         env[<span class="stringliteral">'BKS_COLORS'</span>]={
<a name="l00538"></a>00538         <span class="stringliteral">'BOLD'</span>  :<span class="stringliteral">"\033[1m"</span>,
<a name="l00539"></a>00539         <span class="stringliteral">'RED'</span>   :<span class="stringliteral">"\033[91m"</span>,
<a name="l00540"></a>00540         <span class="stringliteral">'GREEN'</span> :<span class="stringliteral">"\033[92m"</span>,
<a name="l00541"></a>00541         <span class="stringliteral">'YELLOW'</span>:<span class="stringliteral">"\033[93m"</span>, <span class="comment"># unreadable on white backgrounds - fix konsole ?</span>
<a name="l00542"></a>00542         <span class="stringliteral">'BLUE'</span>  :<span class="stringliteral">"\033[94m"</span>,
<a name="l00543"></a>00543         <span class="stringliteral">'CYAN'</span>  :<span class="stringliteral">"\033[96m"</span>,
<a name="l00544"></a>00544         <span class="stringliteral">'NORMAL'</span>:<span class="stringliteral">"\033[0m"</span>,}
<a name="l00545"></a>00545         <span class="keywordflow">if</span> env[<span class="stringliteral">'WINDOWS'</span>] <span class="keywordflow">and</span> <span class="keywordflow">not</span> os.getenv(<span class="stringliteral">"SHELL"</span>): <span class="comment"># downgrade for shells that don't support colors</span>
<a name="l00546"></a>00546                 colors = env[<span class="stringliteral">'BKS_COLORS'</span>]
<a name="l00547"></a>00547                 <span class="keywordflow">for</span> c <span class="keywordflow">in</span> colors.keys():
<a name="l00548"></a>00548                         colors[c] = <span class="stringliteral">""</span>
<a name="l00549"></a>00549                 env[<span class="stringliteral">'BKS_COLORS'</span>] = colors
<a name="l00550"></a>00550 
<a name="l00551"></a>00551         <span class="comment">## Bksys requires scons &gt;= 0.96</span>
<a name="l00552"></a>00552         <span class="keywordflow">try</span>: env.EnsureSConsVersion(0, 96, 91)
<a name="l00553"></a>00553         <span class="keywordflow">except</span>:
<a name="l00554"></a>00554                 pprint(env, <span class="stringliteral">'RED'</span>, <span class="stringliteral">'Your scons version is too old, make sure to use 0.96.91'</span>)
<a name="l00555"></a>00555                 env.Exit(1)
<a name="l00556"></a>00556 
<a name="l00557"></a>00557         <span class="comment">## attach the helper functions to "env"</span>
<a name="l00558"></a>00558         SConsEnvironment.pprint = pprint
<a name="l00559"></a>00559         SConsEnvironment.make_list = make_list
<a name="l00560"></a>00560         SConsEnvironment.join = join
<a name="l00561"></a>00561         SConsEnvironment.dist = dist
<a name="l00562"></a>00562         SConsEnvironment.getreldir = getreldir
<a name="l00563"></a>00563         SConsEnvironment.add_dump = add_dump
<a name="l00564"></a>00564         SConsEnvironment.get_dump = get_dump
<a name="l00565"></a>00565 
<a name="l00566"></a>00566         <span class="comment"># list of the modules which provide a config.h</span>
<a name="l00567"></a>00567         env[<span class="stringliteral">'_CONFIG_H_'</span>]=[]
<a name="l00568"></a>00568 
<a name="l00569"></a>00569         <span class="keyword">import</span> sys
<a name="l00570"></a>00570         env[<span class="stringliteral">'HELP'</span>]=0
<a name="l00571"></a>00571         <span class="keywordflow">if</span> <span class="stringliteral">'--help'</span> <span class="keywordflow">in</span> sys.argv <span class="keywordflow">or</span> <span class="stringliteral">'-h'</span> <span class="keywordflow">in</span> sys.argv <span class="keywordflow">or</span> <span class="stringliteral">'help'</span> <span class="keywordflow">in</span> sys.argv: env[<span class="stringliteral">'HELP'</span>]=1
<a name="l00572"></a>00572         <span class="keywordflow">if</span> env[<span class="stringliteral">'HELP'</span>]:
<a name="l00573"></a>00573                 p=env.pprint
<a name="l00574"></a>00574                 p(<span class="stringliteral">'BOLD'</span>,<span class="stringliteral">'*** Instructions ***'</span>)
<a name="l00575"></a>00575                 p(<span class="stringliteral">'BOLD'</span>,<span class="stringliteral">'--------------------'</span>)
<a name="l00576"></a>00576                 p(<span class="stringliteral">'BOLD'</span>,<span class="stringliteral">'* scons           '</span>,<span class="stringliteral">'to compile'</span>)
<a name="l00577"></a>00577                 p(<span class="stringliteral">'BOLD'</span>,<span class="stringliteral">'* scons -j4       '</span>,<span class="stringliteral">'to compile with several instances'</span>)
<a name="l00578"></a>00578                 p(<span class="stringliteral">'BOLD'</span>,<span class="stringliteral">'* scons install   '</span>,<span class="stringliteral">'to compile and install'</span>)
<a name="l00579"></a>00579                 p(<span class="stringliteral">'BOLD'</span>,<span class="stringliteral">'* scons -c install'</span>,<span class="stringliteral">'to uninstall'</span>)
<a name="l00580"></a>00580                 p(<span class="stringliteral">'BOLD'</span>,<span class="stringliteral">'\n*** Generic options ***'</span>)
<a name="l00581"></a>00581                 p(<span class="stringliteral">'BOLD'</span>,<span class="stringliteral">'--------------------'</span>)
<a name="l00582"></a>00582                 p(<span class="stringliteral">'BOLD'</span>,<span class="stringliteral">'* debug        '</span>,<span class="stringliteral">'debug=1 (-g) or debug=full (-g3, slower) else use environment CXXFLAGS, or -O2 by default'</span>)
<a name="l00583"></a>00583                 p(<span class="stringliteral">'BOLD'</span>,<span class="stringliteral">'* prefix       '</span>,<span class="stringliteral">'the installation path'</span>)
<a name="l00584"></a>00584                 p(<span class="stringliteral">'BOLD'</span>,<span class="stringliteral">'* extraincludes'</span>,<span class="stringliteral">'a list of paths separated by ":"'</span>)
<a name="l00585"></a>00585                 p(<span class="stringliteral">'BOLD'</span>,<span class="stringliteral">'* extralibs'</span>,<span class="stringliteral">'a list of paths separated by ":"'</span>)
<a name="l00586"></a>00586                 p(<span class="stringliteral">'BOLD'</span>,<span class="stringliteral">'* platform'</span>,<span class="stringliteral">'the platform you want to compile for (use same values like QMAKESPEC)'</span>)
<a name="l00587"></a>00587                 p(<span class="stringliteral">'BOLD'</span>,<span class="stringliteral">'* scons configure debug=full prefix=/usr/local extraincludes=/tmp/include:/usr/local extralibs=/usr/local/lib'</span>)
<a name="l00588"></a>00588                 p(<span class="stringliteral">'BOLD'</span>,<span class="stringliteral">'* scons install prefix=/opt/local DESTDIR=/tmp/blah\n'</span>)
<a name="l00589"></a>00589                 <span class="keywordflow">return</span>
<a name="l00590"></a>00590 
<a name="l00591"></a>00591         <span class="comment">#-- Global cache directory</span>
<a name="l00592"></a>00592         <span class="comment"># Put all project files in it so a rm -rf cache will clean up the config</span>
<a name="l00593"></a>00593         <span class="keywordflow">if</span> <span class="keywordflow">not</span> env.has_key(<span class="stringliteral">'CACHEDIR'</span>): env[<span class="stringliteral">'CACHEDIR'</span>] = env.join(os.getcwd(),<span class="stringliteral">'cache'</span>)+os.sep
<a name="l00594"></a>00594         <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.isdir(env[<span class="stringliteral">'CACHEDIR'</span>]): os.mkdir(env[<span class="stringliteral">'CACHEDIR'</span>])
<a name="l00595"></a>00595         
<a name="l00596"></a>00596         <span class="comment">#-- SCons cache directory</span>
<a name="l00597"></a>00597         <span class="comment"># This avoids recompiling the same files over and over again: </span>
<a name="l00598"></a>00598         <span class="comment"># very handy when working with cvs</span>
<a name="l00599"></a>00599         <span class="comment"># TODO: not portable so add a win32 ifdef</span>
<a name="l00600"></a>00600         <span class="keywordflow">if</span> env[<span class="stringliteral">'WINDOWS'</span>] <span class="keywordflow">or</span> os.getuid() != 0:
<a name="l00601"></a>00601                 env.CacheDir( env.join(os.getcwd(),<span class="stringliteral">'cache'</span>,<span class="stringliteral">'objects'</span>) )
<a name="l00602"></a>00602 
<a name="l00603"></a>00603         <span class="comment">#  Avoid spreading .sconsign files everywhere - keep this line</span>
<a name="l00604"></a>00604         env.SConsignFile( env[<span class="stringliteral">'CACHEDIR'</span>]+<span class="stringliteral">'scons_signatures'</span> )
<a name="l00605"></a>00605         
<a name="l00606"></a>00606         <span class="comment"># TODO: this parser is silly, fix scons command-line handling instead</span>
<a name="l00607"></a><a class="code" href="namespacegeneric.html#a40">00607</a>         <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a40">makeHashTable</a>(args):
<a name="l00608"></a>00608                 table = { }
<a name="l00609"></a>00609                 <span class="keywordflow">for</span> arg <span class="keywordflow">in</span> args:
<a name="l00610"></a>00610                         <span class="keywordflow">if</span> len(arg) &gt; 1:
<a name="l00611"></a>00611                                 lst=arg.split(<span class="stringliteral">'='</span>)
<a name="l00612"></a>00612                                 <span class="keywordflow">if</span> len(lst) &lt; 2: <span class="keywordflow">continue</span>
<a name="l00613"></a>00613                                 key=lst[0]
<a name="l00614"></a>00614                                 value=lst[1]
<a name="l00615"></a>00615                                 <span class="keywordflow">if</span> len(key) &gt; 0 <span class="keywordflow">and</span> len(value) &gt;0: table[key] = value
<a name="l00616"></a>00616                 <span class="keywordflow">return</span> table
<a name="l00617"></a>00617 
<a name="l00618"></a>00618         env[<span class="stringliteral">'ARGS'</span>]=makeHashTable(sys.argv)
<a name="l00619"></a>00619 
<a name="l00620"></a>00620         <span class="comment"># Another helper, very handy</span>
<a name="l00621"></a>00621         SConsEnvironment.Chmod = SCons.Action.ActionFactory(os.chmod, <span class="keyword">lambda</span> dest, mode: <span class="stringliteral">'Chmod("%s", 0%o)'</span> % (dest, mode))
<a name="l00622"></a>00622         <span class="comment">#SConsEnvironment.Symlink = SCons.Action.ActionFactory(os.symlink, lambda dest, link: 'symlink("%s", "%s")' % (dest, link))</span>
<a name="l00623"></a>00623 
<a name="l00624"></a>00624         <span class="comment"># Special trick for installing rpms ...</span>
<a name="l00625"></a>00625         env[<span class="stringliteral">'DESTDIR'</span>]=<span class="stringliteral">''</span>
<a name="l00626"></a>00626         <span class="keywordflow">if</span> <span class="stringliteral">'install'</span> <span class="keywordflow">in</span> sys.argv:
<a name="l00627"></a>00627                 dd=<span class="stringliteral">''</span>
<a name="l00628"></a>00628                 <span class="keywordflow">if</span> os.environ.has_key(<span class="stringliteral">'DESTDIR'</span>): dd=os.environ[<span class="stringliteral">'DESTDIR'</span>]
<a name="l00629"></a>00629                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> dd:
<a name="l00630"></a>00630                         <span class="keywordflow">if</span> env[<span class="stringliteral">'ARGS'</span>] <span class="keywordflow">and</span> env[<span class="stringliteral">'ARGS'</span>].has_key(<span class="stringliteral">'DESTDIR'</span>): dd=env[<span class="stringliteral">'ARGS'</span>][<span class="stringliteral">'DESTDIR'</span>]
<a name="l00631"></a>00631                 <span class="keywordflow">if</span> dd:
<a name="l00632"></a>00632                         env[<span class="stringliteral">'DESTDIR'</span>]=dd
<a name="l00633"></a>00633                         env.pprint(<span class="stringliteral">'CYAN'</span>,<span class="stringliteral">'** Enabling DESTDIR for the project ** '</span>,env[<span class="stringliteral">'DESTDIR'</span>])
<a name="l00634"></a>00634 
<a name="l00635"></a>00635         <span class="comment"># Use the same extension .o for all object files</span>
<a name="l00636"></a>00636         env[<span class="stringliteral">'STATIC_AND_SHARED_OBJECTS_ARE_THE_SAME'</span>] = 1
<a name="l00637"></a>00637 
<a name="l00638"></a>00638         <span class="comment"># load the options</span>
<a name="l00639"></a>00639         cachefile=env[<span class="stringliteral">'CACHEDIR'</span>]+<span class="stringliteral">'generic.cache.py'</span>
<a name="l00640"></a>00640         opts = Options(cachefile)
<a name="l00641"></a>00641         opts.AddOptions(
<a name="l00642"></a>00642                 (<span class="stringliteral">'PREFIX'</span>, <span class="stringliteral">'prefix for installation'</span> ),
<a name="l00643"></a>00643                 (<span class="stringliteral">'GENCCFLAGS'</span>, <span class="stringliteral">'C flags'</span> ),
<a name="l00644"></a>00644                 (<span class="stringliteral">'GENCXXFLAGS'</span>, <span class="stringliteral">'additional cxx flags for the project'</span> ),
<a name="l00645"></a>00645                 (<span class="stringliteral">'GENLINKFLAGS'</span>, <span class="stringliteral">'additional link flags'</span> ),
<a name="l00646"></a>00646                 (<span class="stringliteral">'EXTRAINCLUDES'</span>, <span class="stringliteral">'extra include paths for the project'</span> ),
<a name="l00647"></a>00647                 (<span class="stringliteral">'EXTRALIBS'</span>, <span class="stringliteral">'extra library search paths for the project'</span> ),
<a name="l00648"></a>00648                 (<span class="stringliteral">'BKS_DEBUG'</span>, <span class="stringliteral">'debug level: full, trace, or just something'</span> ),
<a name="l00649"></a>00649                 (<span class="stringliteral">'GENERIC_ISCONFIGURED'</span>, <span class="stringliteral">'is the project configured'</span> ),
<a name="l00650"></a>00650                 (<span class="stringliteral">'COMPILERTOOL'</span>, <span class="stringliteral">'compiler to use'</span> ),
<a name="l00651"></a>00651                 (<span class="stringliteral">'PLATFORM'</span>, <span class="stringliteral">'platform to compile for'</span> ),
<a name="l00652"></a>00652         )
<a name="l00653"></a>00653         opts.Update(env)
<a name="l00654"></a>00654         
<a name="l00655"></a>00655         <span class="comment"># Use this to avoid an error message 'how to make target configure ?'</span>
<a name="l00656"></a>00656         env.Alias(<span class="stringliteral">'configure'</span>, <span class="keywordtype">None</span>)
<a name="l00657"></a>00657 
<a name="l00658"></a>00658         <span class="comment"># Check if the following command line arguments have been given</span>
<a name="l00659"></a>00659         <span class="comment"># and set a flag in the environment to show whether or not it was</span>
<a name="l00660"></a>00660         <span class="comment"># given.</span>
<a name="l00661"></a>00661         <span class="keywordflow">if</span> <span class="stringliteral">'install'</span> <span class="keywordflow">in</span> sys.argv:
<a name="l00662"></a>00662                 env[<span class="stringliteral">'_INSTALL_'</span>]=1
<a name="l00663"></a>00663         <span class="keywordflow">else</span>:
<a name="l00664"></a>00664                 env[<span class="stringliteral">'_INSTALL_'</span>]=0
<a name="l00665"></a>00665         <span class="keywordflow">if</span> <span class="stringliteral">'configure'</span> <span class="keywordflow">in</span> sys.argv:
<a name="l00666"></a>00666                 env[<span class="stringliteral">'_CONFIGURE_'</span>]=1
<a name="l00667"></a>00667         <span class="keywordflow">else</span>:
<a name="l00668"></a>00668                 env[<span class="stringliteral">'_CONFIGURE_'</span>]=0
<a name="l00669"></a>00669 
<a name="l00670"></a>00670         <span class="comment"># use the compiler the user wants to have    </span>
<a name="l00671"></a>00671         comp = getCompiler(env,sys)                   
<a name="l00672"></a>00672         <span class="keywordflow">if</span> ( comp != <span class="keyword">False</span> ):                         
<a name="l00673"></a>00673                 Tool(comp).generate(env)                    
<a name="l00674"></a>00674                 env[<span class="stringliteral">'COMPILERTOOL'</span>]=comp                    
<a name="l00675"></a>00675                                                
<a name="l00676"></a>00676         <span class="comment"># Configure the environment if needed</span>
<a name="l00677"></a>00677         <span class="keywordflow">if</span> <span class="keywordflow">not</span> env[<span class="stringliteral">'HELP'</span>] <span class="keywordflow">and</span> (env[<span class="stringliteral">'_CONFIGURE_'</span>] <span class="keywordflow">or</span> <span class="keywordflow">not</span> env.has_key(<span class="stringliteral">'GENERIC_ISCONFIGURED'</span>)):
<a name="l00678"></a>00678                 env[<span class="stringliteral">'_CONFIGURE_'</span>]=1
<a name="l00679"></a>00679 
<a name="l00680"></a>00680                 <span class="keyword">import</span> sys
<a name="l00681"></a>00681                 <span class="keywordflow">if</span> env[<span class="stringliteral">'WINDOWS'</span>]:
<a name="l00682"></a>00682                         sys.path.append(<span class="stringliteral">'bksys'</span>+os.sep+<span class="stringliteral">'win32'</span>)
<a name="l00683"></a>00683                         <span class="keyword">from</span> detect_generic <span class="keyword">import</span> detect
<a name="l00684"></a>00684                 <span class="keywordflow">else</span>:
<a name="l00685"></a>00685                         sys.path.append(<span class="stringliteral">'bksys'</span>+os.sep+<span class="stringliteral">'unix'</span>) <span class="comment"># includes osx</span>
<a name="l00686"></a>00686                         <span class="keyword">from</span> detect_generic <span class="keyword">import</span> detect
<a name="l00687"></a>00687                 detect(env)
<a name="l00688"></a>00688 
<a name="l00689"></a>00689                 env[<span class="stringliteral">'GENERIC_ISCONFIGURED'</span>]=1
<a name="l00690"></a>00690 
<a name="l00691"></a>00691                 env.AppendUnique( GENCXXFLAGS = [<span class="stringliteral">'-DHAVE_CONFIG_H'</span>])
<a name="l00692"></a>00692 
<a name="l00693"></a>00693                 <span class="comment"># And finally save the options in the cache</span>
<a name="l00694"></a>00694                 opts.Save(cachefile, env)
<a name="l00695"></a>00695 
<a name="l00696"></a>00696         <span class="keywordflow">if</span> env[<span class="stringliteral">'_USECOLORS_'</span>]:
<a name="l00697"></a>00697                 c=<span class="stringliteral">'%scompiling%s $TARGET'</span> % (env[<span class="stringliteral">'BKS_COLORS'</span>][<span class="stringliteral">'GREEN'</span>], env[<span class="stringliteral">'BKS_COLORS'</span>][<span class="stringliteral">'NORMAL'</span>])
<a name="l00698"></a>00698                 l=<span class="stringliteral">'%slinking%s $TARGET'</span> % (env[<span class="stringliteral">'BKS_COLORS'</span>][<span class="stringliteral">'YELLOW'</span>], env[<span class="stringliteral">'BKS_COLORS'</span>][<span class="stringliteral">'NORMAL'</span>])
<a name="l00699"></a>00699                 env[<span class="stringliteral">'CCCOMSTR'</span>]    =c
<a name="l00700"></a>00700                 env[<span class="stringliteral">'SHCCCOMSTR'</span>]  =c
<a name="l00701"></a>00701                 env[<span class="stringliteral">'CXXCOMSTR'</span>]   =c
<a name="l00702"></a>00702                 env[<span class="stringliteral">'SHCXXCOMSTR'</span>] =c
<a name="l00703"></a>00703                 env[<span class="stringliteral">'LINKCOMSTR'</span>]  =l
<a name="l00704"></a>00704                 env[<span class="stringliteral">'SHLINKCOMSTR'</span>]=l
<a name="l00705"></a>00705 
<a name="l00706"></a>00706         <span class="comment">## Install files on 'scons install</span>
<a name="l00707"></a><a class="code" href="namespacegeneric.html#a41">00707</a>         <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a41">bksys_install</a>(lenv, subdir, files, destfile=None, perms=None):
<a name="l00708"></a>00708                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> env[<span class="stringliteral">'_INSTALL_'</span>]: <span class="keywordflow">return</span>
<a name="l00709"></a>00709                 basedir = env[<span class="stringliteral">'DESTDIR'</span>]
<a name="l00710"></a>00710                 install_list=<span class="keywordtype">None</span>
<a name="l00711"></a>00711                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> destfile: install_list = env.Install(lenv.join(basedir,subdir), lenv.make_list(files))
<a name="l00712"></a>00712                 <span class="keywordflow">elif</span> subdir:     install_list = env.InstallAs(lenv.join(basedir,subdir,destfile), lenv.make_list(files))
<a name="l00713"></a>00713                 <span class="keywordflow">else</span>:            install_list = env.InstallAs(lenv.join(basedir,destfile), lenv.make_list(files))
<a name="l00714"></a>00714                 <span class="comment"># FIXME: this will not work with a list of files</span>
<a name="l00715"></a>00715                 <span class="comment">#if perms and install_list: lenv.AddPostAction(install_list, lenv.Chmod(install_list, perms))</span>
<a name="l00716"></a>00716                 env.Alias(<span class="stringliteral">'install'</span>, install_list)
<a name="l00717"></a>00717                 <span class="keywordflow">return</span> install_list
<a name="l00718"></a>00718 
<a name="l00719"></a><a class="code" href="namespacegeneric.html#a42">00719</a>         <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a42">bksys_insttype</a>(lenv, type, subdir, files, perms=None):
<a name="l00720"></a>00720                 lenv.bksys_install( lenv.join(lenv.getInstDirForResType(type),subdir), files, destfile=<span class="keywordtype">None</span>, perms=perms)
<a name="l00721"></a>00721 
<a name="l00722"></a>00722         <span class="comment">## Writes a .la file, used by libtool </span>
<a name="l00723"></a><a class="code" href="namespacegeneric.html#a43">00723</a>         <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a43">build_la_file</a>(target, source, env):
<a name="l00724"></a>00724                 dest=open(target[0].path, <span class="stringliteral">'w'</span>)
<a name="l00725"></a>00725                 sname=source[0].name
<a name="l00726"></a>00726                 dest.write(<span class="stringliteral">"# Generated by ltmain.sh - GNU libtool 1.5.18 - (pwn3d by bksys)\n#\n#\n"</span>)
<a name="l00727"></a>00727                 <span class="keywordflow">if</span> len(env[<span class="stringliteral">'BKSYS_VNUM'</span>])&gt;0:
<a name="l00728"></a>00728                         vnum=env[<span class="stringliteral">'BKSYS_VNUM'</span>]
<a name="l00729"></a>00729                         nums=vnum.split(<span class="stringliteral">'.'</span>)
<a name="l00730"></a>00730                         src=source[0].name
<a name="l00731"></a>00731                         name = src.split(<span class="stringliteral">'so.'</span>)[0] + <span class="stringliteral">'so'</span>
<a name="l00732"></a>00732                         strn = src+<span class="stringliteral">" "</span>+name+<span class="stringliteral">"."</span>+str(nums[0])+<span class="stringliteral">" "</span>+name
<a name="l00733"></a>00733                         dest.write(<span class="stringliteral">"dlname='%s'\n"</span> % (name+<span class="stringliteral">'.'</span>+str(nums[0])) )
<a name="l00734"></a>00734                         dest.write(<span class="stringliteral">"library_names='%s'\n"</span> % (strn) )
<a name="l00735"></a>00735                 <span class="keywordflow">else</span>:
<a name="l00736"></a>00736                         dest.write(<span class="stringliteral">"dlname='%s'\n"</span> % sname)
<a name="l00737"></a>00737                         dest.write(<span class="stringliteral">"library_names='%s %s %s'\n"</span> % (sname, sname, sname) )
<a name="l00738"></a>00738                 dest.write(<span class="stringliteral">"old_library=''\ndependency_libs=''\ncurrent=0\n"</span>)
<a name="l00739"></a>00739                 dest.write(<span class="stringliteral">"age=0\nrevision=0\ninstalled=yes\nshouldnotlink=no\n"</span>)
<a name="l00740"></a>00740                 dest.write(<span class="stringliteral">"dlopen=''\ndlpreopen=''\n"</span>)
<a name="l00741"></a>00741                 dest.write(<span class="stringliteral">"libdir='%s'"</span> % env[<span class="stringliteral">'BKSYS_DESTDIR'</span>])
<a name="l00742"></a>00742                 dest.close()
<a name="l00743"></a>00743                 <span class="comment">#return 0</span>
<a name="l00744"></a>00744         
<a name="l00745"></a>00745         <span class="comment">## template for compiling message </span>
<a name="l00746"></a>00746         <span class="keyword">def </span>string_la_file(target, source, env):
<a name="l00747"></a>00747                 blue=<span class="stringliteral">''</span>
<a name="l00748"></a>00748                 normal=<span class="stringliteral">''</span>
<a name="l00749"></a>00749                 <span class="keywordflow">if</span> env[<span class="stringliteral">'_USECOLORS_'</span>]:
<a name="l00750"></a>00750                         blue=env[<span class="stringliteral">'BKS_COLORS'</span>][<span class="stringliteral">'BLUE'</span>]
<a name="l00751"></a>00751                         normal=env[<span class="stringliteral">'BKS_COLORS'</span>][<span class="stringliteral">'NORMAL'</span>]
<a name="l00752"></a>00752                 <span class="keywordflow">return</span> <span class="stringliteral">"%screating%s %s"</span> % (blue, normal, target[0].path)
<a name="l00753"></a>00753 
<a name="l00754"></a>00754         <span class="keywordflow">if</span> env[<span class="stringliteral">'WINDOWS'</span>]:
<a name="l00755"></a>00755                 sys.path.append(<span class="stringliteral">'bksys'</span>+os.sep+<span class="stringliteral">'win32'</span>)
<a name="l00756"></a>00756                 <span class="keyword">from</span> detect_generic <span class="keyword">import</span> build_la_file
<a name="l00757"></a>00757         la_file = env.Action(build_la_file, string_la_file)
<a name="l00758"></a>00758         env[<span class="stringliteral">'BUILDERS'</span>][<span class="stringliteral">'LaFile'</span>] = env.Builder(action=la_file,suffix=<span class="stringliteral">'.la'</span>,src_suffix=env[<span class="stringliteral">'SHLIBSUFFIX'</span>])
<a name="l00759"></a>00759 
<a name="l00760"></a>00760         <span class="comment">## Build symlinks</span>
<a name="l00761"></a><a class="code" href="namespacegeneric.html#a44">00761</a>         <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a44">symlink_command</a>(target, source, env):
<a name="l00762"></a>00762                 os.symlink( str(source[0].name), target[0].path)
<a name="l00763"></a>00763 
<a name="l00764"></a>00764         <span class="comment">## template for symbolic linking targets message</span>
<a name="l00765"></a><a class="code" href="namespacegeneric.html#a45">00765</a>         <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a45">symlink_str</a>(target, source, env):
<a name="l00766"></a>00766                 yellow=<span class="stringliteral">''</span>
<a name="l00767"></a>00767                 normal=<span class="stringliteral">''</span>
<a name="l00768"></a>00768                 <span class="keywordflow">if</span> env[<span class="stringliteral">'_USECOLORS_'</span>]:
<a name="l00769"></a>00769                         yellow=env[<span class="stringliteral">'BKS_COLORS'</span>][<span class="stringliteral">'YELLOW'</span>]
<a name="l00770"></a>00770                         normal=env[<span class="stringliteral">'BKS_COLORS'</span>][<span class="stringliteral">'NORMAL'</span>]
<a name="l00771"></a>00771                 <span class="keywordflow">return</span> <span class="stringliteral">"%ssymlinking%s %s (-&gt; %s)"</span> % (yellow, normal, target[0].path, str(source[0].name) )
<a name="l00772"></a>00772         symlink = env.Action(symlink_command, symlink_str)
<a name="l00773"></a>00773         env[<span class="stringliteral">'BUILDERS'</span>][<span class="stringliteral">'SymLink'</span>] = env.Builder(action=symlink)
<a name="l00774"></a>00774 
<a name="l00775"></a>00775         <span class="comment">## Function for building shared libraries</span>
<a name="l00776"></a><a class="code" href="namespacegeneric.html#a46">00776</a>         <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a46">bksys_shlib</a>(lenv, ntarget, source, libdir, libprefix='lib', vnum='', noinst=None):
<a name="l00777"></a>00777                 <span class="stringliteral">"""Installs a shared library, with or without a version number, and create a</span>
<a name="l00778"></a>00778 <span class="stringliteral">                .la file for use by libtool.</span>
<a name="l00779"></a>00779 <span class="stringliteral">                </span>
<a name="l00780"></a>00780 <span class="stringliteral">                If library version numbering is to be used, the version number</span>
<a name="l00781"></a>00781 <span class="stringliteral">                should be passed as a period-delimited version number (e.g.</span>
<a name="l00782"></a>00782 <span class="stringliteral">                vnum = '1.2.3').  This causes the library to be installed</span>
<a name="l00783"></a>00783 <span class="stringliteral">                with its full version number, and with symlinks pointing to it.</span>
<a name="l00784"></a>00784 <span class="stringliteral">                </span>
<a name="l00785"></a>00785 <span class="stringliteral">                For example, for libfoo version 1.2.3, install the file</span>
<a name="l00786"></a>00786 <span class="stringliteral">                libfoo.so.1.2.3, and create symlinks libfoo.so and</span>
<a name="l00787"></a>00787 <span class="stringliteral">                libfoo.so.1 that point to it.</span>
<a name="l00788"></a>00788 <span class="stringliteral">                """</span>
<a name="l00789"></a>00789                 <span class="comment"># parameter can be a list</span>
<a name="l00790"></a>00790                 <span class="keywordflow">if</span> type(ntarget) <span class="keywordflow">is</span> types.ListType: target=ntarget[0]
<a name="l00791"></a>00791                 <span class="keywordflow">else</span>: target=ntarget
<a name="l00792"></a>00792 
<a name="l00793"></a>00793                 thisenv = lenv.Copy() <span class="comment"># copying an existing environment is +/- cheap</span>
<a name="l00794"></a>00794                 thisenv[<span class="stringliteral">'BKSYS_DESTDIR'</span>]=libdir
<a name="l00795"></a>00795                 thisenv[<span class="stringliteral">'BKSYS_VNUM'</span>]=vnum
<a name="l00796"></a>00796                 thisenv[<span class="stringliteral">'SHLIBPREFIX'</span>]=libprefix
<a name="l00797"></a>00797 
<a name="l00798"></a>00798                 <span class="keywordflow">if</span> len(vnum)&gt;0:
<a name="l00799"></a>00799                         <span class="keywordflow">if</span> sys.platform == <span class="stringliteral">'darwin'</span>:
<a name="l00800"></a>00800                                 thisenv[<span class="stringliteral">'SHLIBSUFFIX'</span>]=<span class="stringliteral">'.'</span>+vnum+<span class="stringliteral">'.dylib'</span>
<a name="l00801"></a>00801                         <span class="keywordflow">else</span>:
<a name="l00802"></a>00802                                 thisenv[<span class="stringliteral">'SHLIBSUFFIX'</span>]=<span class="stringliteral">'.so.'</span>+vnum
<a name="l00803"></a>00803                         thisenv.Depends(target, thisenv.Value(vnum))
<a name="l00804"></a>00804                         num=vnum.split(<span class="stringliteral">'.'</span>)[0]
<a name="l00805"></a>00805                         lst=target.split(os.sep)
<a name="l00806"></a>00806                         tname=lst[len(lst)-1]
<a name="l00807"></a>00807                         libname=tname.split(<span class="stringliteral">'.'</span>)[0]
<a name="l00808"></a>00808                         <span class="comment"># TODO: proper handling of bundles (LD* instead of LIB* in scons?)</span>
<a name="l00809"></a>00809                         <span class="comment"># TODO: -undefined dynamic_lookup == "allow undefined", need proper support for</span>
<a name="l00810"></a>00810                         <span class="comment"># -no-undefined and similar in such a way that's cross-platform</span>
<a name="l00811"></a>00811                         <span class="comment"># DF: do we ever want shlibs with undefined symbols? How about we avoid that? :)</span>
<a name="l00812"></a>00812                         <span class="comment"># IIRC windows DLLs can't have undefined symbols.</span>
<a name="l00813"></a>00813                         <span class="keywordflow">if</span> sys.platform == <span class="stringliteral">'darwin'</span>:
<a name="l00814"></a>00814                                 thisenv.AppendUnique(LINKFLAGS = [<span class="stringliteral">"-undefined"</span>,<span class="stringliteral">"error"</span>,<span class="stringliteral">"-install_name"</span>, <span class="stringliteral">"%s.%s.dylib"</span> % (libname, num)] )
<a name="l00815"></a>00815                         <span class="keywordflow">else</span>:
<a name="l00816"></a>00816                                 thisenv.AppendUnique(LINKFLAGS = [<span class="stringliteral">"-Wl,--no-undefined"</span>,<span class="stringliteral">"-Wl,--soname=%s.so.%s"</span> % (libprefix+libname, num)] )
<a name="l00817"></a>00817 
<a name="l00818"></a>00818                 <span class="comment"># Fix against a scons bug - shared libs and ordinal out of range(128)</span>
<a name="l00819"></a>00819                 <span class="keywordflow">if</span> type(source) <span class="keywordflow">is</span> types.ListType:
<a name="l00820"></a>00820                         src2=[]
<a name="l00821"></a>00821                         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> source: src2.append( str(i) )
<a name="l00822"></a>00822                         source=src2
<a name="l00823"></a>00823 
<a name="l00824"></a>00824                 library_list = thisenv.SharedLibrary(target, source)
<a name="l00825"></a>00825                 lafile_list  = thisenv.LaFile(libprefix+target, library_list)
<a name="l00826"></a>00826 
<a name="l00827"></a>00827                 <span class="comment"># Install the libraries automatically</span>
<a name="l00828"></a>00828                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> thisenv.has_key(<span class="stringliteral">'NOAUTOINSTALL'</span>) <span class="keywordflow">and</span> <span class="keywordflow">not</span> noinst <span class="keywordflow">and</span> libdir:
<a name="l00829"></a>00829                         inst_lib=thisenv.bksys_install(libdir, library_list)
<a name="l00830"></a>00830                         thisenv.bksys_install(libdir, lafile_list)      
<a name="l00831"></a>00831 
<a name="l00832"></a>00832                 <span class="comment"># Handle the versioning</span>
<a name="l00833"></a>00833                 <span class="keywordflow">if</span> len(vnum)&gt;0:
<a name="l00834"></a>00834                         nums=vnum.split(<span class="stringliteral">'.'</span>)
<a name="l00835"></a>00835                         symlinkcom = (<span class="stringliteral">'cd $SOURCE.dir &amp;&amp; rm -f $TARGET.name &amp;&amp; ln -s $SOURCE.name $TARGET.name'</span>)
<a name="l00836"></a>00836                         <span class="keywordflow">if</span> sys.platform == <span class="stringliteral">'darwin'</span>:
<a name="l00837"></a>00837                                 tg = libprefix+target+<span class="stringliteral">'.'</span>+vnum+<span class="stringliteral">'.dylib'</span>
<a name="l00838"></a>00838                                 nm1 = libprefix+target+<span class="stringliteral">'.dylib'</span>
<a name="l00839"></a>00839                                 nm2 = libprefix+target+<span class="stringliteral">'.'</span>+nums[0]+<span class="stringliteral">'.dylib'</span>
<a name="l00840"></a>00840                         <span class="keywordflow">else</span>:
<a name="l00841"></a>00841                                 tg = libprefix+target+<span class="stringliteral">'.so.'</span>+vnum
<a name="l00842"></a>00842                                 nm1 = libprefix+target+<span class="stringliteral">'.so'</span>
<a name="l00843"></a>00843                                 nm2 = libprefix+target+<span class="stringliteral">'.so.'</span>+nums[0]
<a name="l00844"></a>00844 
<a name="l00845"></a>00845                         thisenv.SymLink(target=nm1, source=library_list)
<a name="l00846"></a>00846                         thisenv.SymLink(target=nm2, source=library_list)
<a name="l00847"></a>00847 
<a name="l00848"></a>00848                         <span class="keywordflow">if</span> env[<span class="stringliteral">'_INSTALL_'</span>] <span class="keywordflow">and</span> libdir:
<a name="l00849"></a>00849                                 link1 = env.join(str(inst_lib[0].dir), nm1)
<a name="l00850"></a>00850                                 link2 = env.join(str(inst_lib[0].dir), nm2)
<a name="l00851"></a>00851                                 src   = str(inst_lib[0].name)
<a name="l00852"></a>00852                                 env.Alias(<span class="stringliteral">'install'</span>, env.SymLink(target=link1, source=src))
<a name="l00853"></a>00853                                 env.Alias(<span class="stringliteral">'install'</span>, env.SymLink(target=link2, source=src))
<a name="l00854"></a>00854                 <span class="keywordflow">return</span> library_list
<a name="l00855"></a>00855 
<a name="l00856"></a>00856         <span class="comment">## Declare scons scripts to process</span>
<a name="l00857"></a><a class="code" href="namespacegeneric.html#a47">00857</a>         <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a47">subdirs</a>(lenv, folderlist):
<a name="l00858"></a>00858                 flist=lenv.make_list(folderlist)
<a name="l00859"></a>00859                 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> flist:
<a name="l00860"></a>00860                         lenv[<span class="stringliteral">'CURBUILDDIR'</span>] = i[1:]
<a name="l00861"></a>00861                         lenv.SConscript(lenv.join(i, <span class="stringliteral">'SConscript'</span>))
<a name="l00862"></a>00862                 <span class="comment"># take all objects - warn those who are not already executed</span>
<a name="l00863"></a>00863                 <span class="keywordflow">if</span> lenv.has_key(<span class="stringliteral">'USE_THE_FORCE_LUKE'</span>):
<a name="l00864"></a>00864                         <span class="keywordflow">for</span> ke <span class="keywordflow">in</span> lenv[<span class="stringliteral">'USE_THE_FORCE_LUKE'</span>]:
<a name="l00865"></a>00865                                 <span class="keywordflow">if</span> ke.executed: <span class="keywordflow">continue</span>
<a name="l00866"></a>00866                                 lenv.pprint(<span class="stringliteral">'GREEN'</span>,<span class="stringliteral">"you forgot to execute object "</span>+ke.target)
<a name="l00867"></a>00867                                 ke.lockworkdir()
<a name="l00868"></a>00868                                 ke.execute()
<a name="l00869"></a>00869                                 ke.unlockworkdir()
<a name="l00870"></a>00870         
<a name="l00871"></a>00871         <span class="comment">## Links against a shared library made in the project </span>
<a name="l00872"></a>00872         <span class="keyword">def </span>link_local_shlib(lenv, str):
<a name="l00873"></a>00873                 lst = lenv.make_list(str)
<a name="l00874"></a>00874                 <span class="keywordflow">for</span> afile <span class="keywordflow">in</span> lst:
<a name="l00875"></a>00875                         <span class="keyword">import</span> re
<a name="l00876"></a>00876                         file = slashify(afile)
<a name="l00877"></a>00877 
<a name="l00878"></a>00878                         <span class="keywordflow">if</span> sys.platform == <span class="stringliteral">'darwin'</span>:
<a name="l00879"></a>00879                                 reg=re.compile(<span class="stringliteral">"(.*)/lib(.*).(la|so|dylib)$"</span>)
<a name="l00880"></a>00880                         <span class="keywordflow">else</span>:
<a name="l00881"></a>00881                                 reg=re.compile(<span class="stringliteral">"(.*)/lib(.*).(la|so)$"</span>)
<a name="l00882"></a>00882                         result=reg.match(file)
<a name="l00883"></a>00883                         <span class="keywordflow">if</span> <span class="keywordflow">not</span> result:
<a name="l00884"></a>00884                                 <span class="keywordflow">if</span> sys.platform == <span class="stringliteral">'darwin'</span>:
<a name="l00885"></a>00885                                         reg = re.compile(<span class="stringliteral">"(.*)/lib(.*)\.(\d+)\.(la|so|dylib)"</span>)
<a name="l00886"></a>00886                                 <span class="keywordflow">else</span>:
<a name="l00887"></a>00887                                         reg = re.compile(<span class="stringliteral">"(.*)/lib(.*)\.(la|so)\.(\d+)"</span>)
<a name="l00888"></a>00888                                 result=reg.match(file)
<a name="l00889"></a>00889                                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> result:
<a name="l00890"></a>00890                                         <span class="keywordflow">print</span> <span class="stringliteral">"Unknown la file given "</span>+file
<a name="l00891"></a>00891                                         <span class="keywordflow">continue</span>
<a name="l00892"></a>00892                                 dir  = result.group(1)
<a name="l00893"></a>00893                                 link = result.group(2)
<a name="l00894"></a>00894                         <span class="keywordflow">else</span>:
<a name="l00895"></a>00895                                 dir  = result.group(1)
<a name="l00896"></a>00896                                 link = result.group(2)
<a name="l00897"></a>00897 
<a name="l00898"></a>00898                         lenv.AppendUnique(LIBS = [link])
<a name="l00899"></a>00899                         lenv.PrependUnique(LIBPATH = [dir])
<a name="l00900"></a>00900         
<a name="l00901"></a>00901         <span class="comment">## Links against a static library made in the project </span>
<a name="l00902"></a><a class="code" href="namespacegeneric.html#a48">00902</a>         <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a48">link_local_staticlib</a>(lenv, str):
<a name="l00903"></a>00903                 lst = lenv.make_list(str)
<a name="l00904"></a>00904                 <span class="keywordflow">for</span> afile <span class="keywordflow">in</span> lst:
<a name="l00905"></a>00905                         <span class="keyword">import</span> re
<a name="l00906"></a>00906                         file = slashify(afile)
<a name="l00907"></a>00907                         reg = re.compile(<span class="stringliteral">"(.*)/(lib.*.a)"</span>)
<a name="l00908"></a>00908                         result = reg.match(file)
<a name="l00909"></a>00909                         <span class="keywordflow">if</span> <span class="keywordflow">not</span> result:
<a name="l00910"></a>00910                                 <span class="keywordflow">print</span> <span class="stringliteral">"Unknown archive file given "</span>+file
<a name="l00911"></a>00911                                 <span class="keywordflow">continue</span>
<a name="l00912"></a>00912                         f=SCons.Node.FS.default_fs.File(file)
<a name="l00913"></a>00913                         lenv.Append(LIBPATH=[f.dir])
<a name="l00914"></a>00914                         lenv.Append(LIBS=[f.name])
<a name="l00915"></a>00915 
<a name="l00916"></a><a class="code" href="namespacegeneric.html#a49">00916</a>         <span class="keyword">def </span><a class="code" href="namespacegeneric.html#a49">create_file</a>(target, source, env):
<a name="l00917"></a>00917                 f = open(str(target[0]), <span class="stringliteral">'wb'</span>)
<a name="l00918"></a>00918                 f.write(source[0].get_contents())
<a name="l00919"></a>00919                 f.close()
<a name="l00920"></a>00920         
<a name="l00921"></a>00921         env[<span class="stringliteral">'BUILDERS'</span>][<span class="stringliteral">'CreateFile'</span>] = env.Builder(action = create_file)
<a name="l00922"></a>00922         
<a name="l00923"></a>00923         SConsEnvironment.bksys_install = bksys_install
<a name="l00924"></a>00924         SConsEnvironment.bksys_insttype = bksys_insttype
<a name="l00925"></a>00925 
<a name="l00926"></a>00926         <span class="keywordflow">if</span> env[<span class="stringliteral">'WINDOWS'</span>]:
<a name="l00927"></a>00927                 sys.path.append(<span class="stringliteral">'bksys'</span>+os.sep+<span class="stringliteral">'win32'</span>)
<a name="l00928"></a>00928                 <span class="keyword">from</span> detect_generic <span class="keyword">import</span> bksys_shlib
<a name="l00929"></a>00929         SConsEnvironment.bksys_shlib   = bksys_shlib
<a name="l00930"></a>00930 
<a name="l00931"></a>00931         SConsEnvironment.subdirs       = subdirs
<a name="l00932"></a>00932         SConsEnvironment.link_local_shlib = link_local_shlib
<a name="l00933"></a>00933         SConsEnvironment.link_local_staticlib = link_local_staticlib
<a name="l00934"></a>00934         SConsEnvironment.genobj=genobj
<a name="l00935"></a>00935         SConsEnvironment.find_path=find_path
<a name="l00936"></a>00936         SConsEnvironment.find_file=find_file
<a name="l00937"></a>00937         SConsEnvironment.find_program=find_program
<a name="l00938"></a>00938         SConsEnvironment.find_program_using_which=find_program_using_which
<a name="l00939"></a>00939         SConsEnvironment.getInstDirForResType=getInstDirForResType
<a name="l00940"></a>00940 
<a name="l00941"></a>00941         <span class="keywordflow">if</span> env.has_key(<span class="stringliteral">'GENCXXFLAGS'</span>):   env.AppendUnique( CPPFLAGS  = env[<span class="stringliteral">'GENCXXFLAGS'</span>] )
<a name="l00942"></a>00942         <span class="keywordflow">if</span> env.has_key(<span class="stringliteral">'GENCCFLAGS'</span>):    env.AppendUnique( CCFLAGS   = env[<span class="stringliteral">'GENCCFLAGS'</span>] )
<a name="l00943"></a>00943         <span class="keywordflow">if</span> env.has_key(<span class="stringliteral">'GENLINKFLAGS'</span>):  env.AppendUnique( LINKFLAGS = env[<span class="stringliteral">'GENLINKFLAGS'</span>] )
<a name="l00944"></a>00944         <span class="keywordflow">if</span> env.has_key(<span class="stringliteral">'EXTRAINCLUDES'</span>): env.AppendUnique( CPPPATH   = env[<span class="stringliteral">'EXTRAINCLUDES'</span>])
<a name="l00945"></a>00945         <span class="keywordflow">if</span> env.has_key(<span class="stringliteral">'EXTRALIBS'</span>):     env.AppendUnique( LINKFLAGS = env[<span class="stringliteral">'EXTRALIBS'</span>])
<a name="l00946"></a>00946 
<a name="l00947"></a>00947         <span class="keywordflow">if</span> env.has_key(<span class="stringliteral">'BKS_DEBUG'</span>):
<a name="l00948"></a>00948                 <span class="keywordflow">if</span> (env[<span class="stringliteral">'BKS_DEBUG'</span>] == <span class="stringliteral">"full"</span>):
<a name="l00949"></a>00949                         env.AppendUnique(CXXFLAGS = [<span class="stringliteral">'-DDEBUG'</span>])
<a name="l00950"></a>00950                         <span class="keywordflow">if</span> env[<span class="stringliteral">'WINDOWS'</span>] <span class="keywordflow">and</span> env[<span class="stringliteral">'COMPILERTOOL'</span>] == <span class="stringliteral">'msvc'</span>:
<a name="l00951"></a>00951                                 env.AppendUnique(CXXFLAGS = [<span class="stringliteral">'-Od'</span>,<span class="stringliteral">'-W3'</span>])
<a name="l00952"></a>00952                         <span class="keywordflow">else</span>:
<a name="l00953"></a>00953                                 env.AppendUnique(CXXFLAGS = [<span class="stringliteral">'-g3'</span>, <span class="stringliteral">'-Wall'</span>])
<a name="l00954"></a>00954                 <span class="keywordflow">elif</span> (env[<span class="stringliteral">'BKS_DEBUG'</span>] == <span class="stringliteral">"trace"</span>): <span class="comment"># i cannot remember who wanted this (TODO ita)</span>
<a name="l00955"></a>00955                         env.AppendUnique(
<a name="l00956"></a>00956                                 LINKFLAGS=env.Split(<span class="stringliteral">"-lmrwlog4cxxconfiguration -lmrwautofunctiontracelog4cxx -finstrument-functions"</span>),
<a name="l00957"></a>00957                                 CXXFLAGS=env.Split(<span class="stringliteral">"-DDEBUG -Wall -finstrument-functions -g3 -O0"</span>))
<a name="l00958"></a>00958                 <span class="keywordflow">else</span>:
<a name="l00959"></a>00959                         env.AppendUnique(CXXFLAGS = [<span class="stringliteral">'-DDEBUG'</span>, <span class="stringliteral">'-g'</span>, <span class="stringliteral">'-Wall'</span>])
<a name="l00960"></a>00960 
<a name="l00961"></a>00961         env.Export(<span class="stringliteral">'env'</span>)
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun Oct 23 01:55:16 2005 for BKSYS - Build Kde SYStem by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.4 </small></address>
</body>
</html>
