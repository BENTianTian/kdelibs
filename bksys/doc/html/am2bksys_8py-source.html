<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>BKSYS - Build Kde SYStem: am2bksys.py Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Packages</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>am2bksys.py</h1><a href="am2bksys_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespaceam2bksys.html">00001</a> <span class="comment">#! /usr/bin/env python</span>
<a name="l00002"></a>00002 <span class="comment">## </span>
<a name="l00003"></a>00003 <span class="comment"># @file </span>
<a name="l00004"></a>00004 <span class="comment"># bksys Makefile.am related tools</span>
<a name="l00005"></a>00005 <span class="comment"># </span>
<a name="l00006"></a>00006 <span class="comment"># a Makefile.am to scons converter</span>
<a name="l00007"></a>00007 <span class="comment">#</span>
<a name="l00008"></a>00008 <span class="comment"># (@) 2005 LiuCougar  - published under the GPL license</span>
<a name="l00009"></a>00009 <span class="comment">#</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="keyword">import</span> os, re, types, sys, string, shutil, stat, glob, amtool
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="comment">## Class for automatically converting Makefile.am to SConscript</span>
<a name="l00014"></a>00014 <span class="comment">#</span>
<a name="l00015"></a>00015 <span class="comment"># The class can handle simple Makefile.am 100% correct, for complex ones, manual</span>
<a name="l00016"></a>00016 <span class="comment"># fine-tunning is required. These are something that can not handle:</span>
<a name="l00017"></a>00017 <span class="comment">#               - Custom make target</span>
<a name="l00018"></a>00018 <span class="comment">#               - extra moc files</span>
<a name="l00019"></a>00019 <span class="comment">#               - checking programs (test/EXTRA, how to enable checking?? )</span>
<a name="l00020"></a>00020 <span class="comment">#               - conditional compilation</span>
<a name="l00021"></a>00021 <span class="comment">#               - install dir support</span>
<a name="l00022"></a>00022 <span class="comment">#               - DATA files handling</span>
<a name="l00023"></a>00023 <span class="comment">#</span>
<a name="l00024"></a>00024 <span class="comment">#</span>
<a name="l00025"></a>00025 
<a name="l00026"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html">00026</a> <span class="keyword">class </span><a class="code" href="classam2bksys_1_1AM2Bksys.html">AM2Bksys</a>(amtool.AMFile):
<a name="l00027"></a>00027         <span class="keyword">def </span>__init__(self):
<a name="l00028"></a>00028                 amtool.AMFile.__init__(self)
<a name="l00029"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#o0">00029</a>                 self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#o0">ignoreIncludePaths</a> = [<span class="stringliteral">'$(top_srcdir)'</span>, <span class="stringliteral">'$(all_includes)'</span>]
<a name="l00030"></a>00030 
<a name="l00031"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#o1">00031</a>                 self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#o1">defaultUseLibs</a> = <span class="stringliteral">'QT QTCORE QTGUI QT3SUPPORT KDE4'</span>
<a name="l00032"></a>00032 
<a name="l00033"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#o2">00033</a>                 self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#o2">LibHandlerMapping</a> = {
<a name="l00034"></a>00034                 <span class="stringliteral">'noinst'</span> : <span class="stringliteral">'env.kdeobj(\'convenience\')'</span>,
<a name="l00035"></a>00035                 <span class="stringliteral">'kdeinit'</span> : <span class="stringliteral">'env.kdeinitobj()'</span>,
<a name="l00036"></a>00036                 <span class="stringliteral">'lib'</span> : <span class="stringliteral">'env.kdeobj(\'shlib\')\nobj.it_is_a_kdelib()'</span>,
<a name="l00037"></a>00037                 <span class="stringliteral">'kde_module'</span> : <span class="stringliteral">'env.kdeobj(\'module\')'</span>,
<a name="l00038"></a>00038                 }
<a name="l00039"></a>00039                 
<a name="l00040"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#o3">00040</a>                 self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#o3">ProgHandlerMapping</a> = {
<a name="l00041"></a>00041                 <span class="stringliteral">'bin'</span> : <span class="stringliteral">'env.kdeobj(\'program\')'</span>,
<a name="l00042"></a>00042                 <span class="stringliteral">'check'</span> : <span class="stringliteral">'env.kdeobj(\'program\')\nobj.env = env.Copy()\nobj.env[\'NOAUTOINSTALL\'] = 1'</span>,
<a name="l00043"></a>00043                 <span class="stringliteral">'EXTRA'</span> : <span class="stringliteral">'env.kdeobj(\'program\')\nobj.env = env.Copy()\nobj.env[\'NOAUTOINSTALL\'] = 1'</span>,
<a name="l00044"></a>00044                 }
<a name="l00045"></a>00045                 
<a name="l00046"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#o4">00046</a>                 self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#o4">DataHandlerMapping</a> = {
<a name="l00047"></a>00047                         <span class="stringliteral">'kde_htmldir'</span> : <span class="stringliteral">''</span>,
<a name="l00048"></a>00048                         <span class="stringliteral">'kde_appsdir'</span> : <span class="stringliteral">'KDEAPPS'</span>,
<a name="l00049"></a>00049                         <span class="stringliteral">'kde_icondir'</span> : <span class="stringliteral">'KDEICONS'</span>,
<a name="l00050"></a>00050                         <span class="stringliteral">'kde_sounddir'</span> : <span class="stringliteral">''</span>,
<a name="l00051"></a>00051                         <span class="stringliteral">'kde_datadir'</span> : <span class="stringliteral">'KDEDATA'</span>,
<a name="l00052"></a>00052                         <span class="stringliteral">'kde_locale'</span> : <span class="stringliteral">'KDELOCALE'</span>,
<a name="l00053"></a>00053                         <span class="stringliteral">'kde_cgidir'</span> : <span class="stringliteral">''</span>,
<a name="l00054"></a>00054                         <span class="stringliteral">'kde_confdir'</span> : <span class="stringliteral">'KDECONF'</span>,
<a name="l00055"></a>00055                         <span class="stringliteral">'kde_kcfgdir'</span> : <span class="stringliteral">'KDEKCFG'</span>,
<a name="l00056"></a>00056                         <span class="stringliteral">'kde_mimedir'</span> : <span class="stringliteral">'KDEMIME'</span>,
<a name="l00057"></a>00057                         <span class="stringliteral">'kde_toolbardir'</span> : <span class="stringliteral">''</span>,
<a name="l00058"></a>00058                         <span class="stringliteral">'kde_wallpaperdir'</span> : <span class="stringliteral">''</span>,
<a name="l00059"></a>00059                         <span class="stringliteral">'kde_templatesdir'</span> : <span class="stringliteral">''</span>,
<a name="l00060"></a>00060                         <span class="stringliteral">'kde_bindir'</span> : <span class="stringliteral">'KDEBIN'</span>,
<a name="l00061"></a>00061                         <span class="stringliteral">'kde_servicesdir'</span> : <span class="stringliteral">'KDESERV'</span>,
<a name="l00062"></a>00062                         <span class="stringliteral">'kde_servicetypesdir'</span> : <span class="stringliteral">'KDESERVTYPES'</span>,
<a name="l00063"></a>00063                         <span class="stringliteral">'kde_moduledir'</span> : <span class="stringliteral">'KDEMODULE'</span>,
<a name="l00064"></a>00064                         <span class="stringliteral">'kde_styledir'</span> : <span class="stringliteral">''</span>,
<a name="l00065"></a>00065                         <span class="stringliteral">'kde_widgetdir'</span> : <span class="stringliteral">''</span>,
<a name="l00066"></a>00066                         <span class="stringliteral">'xdg_appsdir'</span> : <span class="stringliteral">''</span>,
<a name="l00067"></a>00067                         <span class="stringliteral">'xdg_menudir'</span> : <span class="stringliteral">''</span>,
<a name="l00068"></a>00068                         <span class="stringliteral">'xdg_directorydir'</span> : <span class="stringliteral">''</span>,
<a name="l00069"></a>00069                 }
<a name="l00070"></a>00070                 
<a name="l00071"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#o5">00071</a>                 self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#o5">out_buf_header</a> = <span class="stringliteral">"""#! /usr/bin/env python</span>
<a name="l00072"></a>00072 <span class="stringliteral">#generated from %s by am2bksys.py</span>
<a name="l00073"></a>00073 <span class="stringliteral">Import('env')</span>
<a name="l00074"></a>00074 <span class="stringliteral"></span>
<a name="l00075"></a>00075 <span class="stringliteral">"""</span>
<a name="l00076"></a>00076         <span class="comment">#generate source lists</span>
<a name="l00077"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#a0">00077</a>         <span class="keyword">def </span><a class="code" href="classam2bksys_1_1AM2Bksys.html#a0">generateSources</a>(self):
<a name="l00078"></a>00078                 out_buf = <span class="stringliteral">""</span>
<a name="l00079"></a>00079                 <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.self.sources.keys():
<a name="l00080"></a>00080                         out_buf += key + <span class="stringliteral">"_sources = \"\"\"\n"</span>
<a name="l00081"></a>00081                         sources = self.self.sources[key].split()
<a name="l00082"></a>00082                         sources.sort()
<a name="l00083"></a>00083                         
<a name="l00084"></a>00084                         <span class="keywordflow">while</span> len(sources) &gt;= 4:
<a name="l00085"></a>00085                                 out_buf += <span class="stringliteral">' '</span>.join(sources[:4]) + <span class="stringliteral">"\n"</span>
<a name="l00086"></a>00086                                 del sources[:4]
<a name="l00087"></a>00087                         <span class="keywordflow">if</span> len(sources):
<a name="l00088"></a>00088                                 out_buf += <span class="stringliteral">' '</span>.join(sources) + <span class="stringliteral">"\n"</span>
<a name="l00089"></a>00089                         out_buf += <span class="stringliteral">"\"\"\"\n\n"</span>
<a name="l00090"></a>00090                 <span class="keywordflow">return</span> out_buf
<a name="l00091"></a>00091 
<a name="l00092"></a>00092         <span class="comment">#generate header file lists</span>
<a name="l00093"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#a1">00093</a>         <span class="keyword">def </span><a class="code" href="classam2bksys_1_1AM2Bksys.html#a1">generateHeaders</a>(self):
<a name="l00094"></a>00094                 out_buf = <span class="stringliteral">""</span>
<a name="l00095"></a>00095                 <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.self.headers.keys():
<a name="l00096"></a>00096                         out_buf += key + <span class="stringliteral">"_headers = \"\"\"\n"</span>
<a name="l00097"></a>00097                         headers = self.self.headers[key].split()
<a name="l00098"></a>00098                         headers.sort()
<a name="l00099"></a>00099                         
<a name="l00100"></a>00100                         <span class="keywordflow">while</span> len(headers) &gt;= 4:
<a name="l00101"></a>00101                                 out_buf += <span class="stringliteral">' '</span>.join(headers[:4]) + <span class="stringliteral">"\n"</span>
<a name="l00102"></a>00102                                 del headers[:4]
<a name="l00103"></a>00103                         <span class="keywordflow">if</span> len(headers):
<a name="l00104"></a>00104                                 out_buf += <span class="stringliteral">' '</span>.join(headers) + <span class="stringliteral">"\n"</span>
<a name="l00105"></a>00105                         out_buf += <span class="stringliteral">"\"\"\"\n\n"</span>
<a name="l00106"></a>00106                 <span class="keywordflow">return</span> out_buf
<a name="l00107"></a>00107 
<a name="l00108"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#a2">00108</a>         <span class="keyword">def </span><a class="code" href="classam2bksys_1_1AM2Bksys.html#a2">generateLibadds</a>(self, name):
<a name="l00109"></a>00109                 reg = re.compile(<span class="stringliteral">"(.*)lib([^/]*)\.la$"</span>)
<a name="l00110"></a>00110                 <span class="keyword">def </span>convertLocalLibs(lib):
<a name="l00111"></a>00111                         lib = lib.replace(<span class="stringliteral">'$(top_srcdir)'</span>, <span class="stringliteral">'#'</span>)
<a name="l00112"></a>00112                         lib = lib.replace(<span class="stringliteral">'$(top_builddir)'</span>, <span class="stringliteral">'##'</span>)
<a name="l00113"></a>00113                         lib = lib.replace(<span class="stringliteral">'$(srcdir)/'</span>, <span class="stringliteral">''</span>)
<a name="l00114"></a>00114                         result=reg.match(lib)
<a name="l00115"></a>00115                         <span class="keywordflow">if</span> result:
<a name="l00116"></a>00116                                 path = result.group(1)
<a name="l00117"></a>00117                                 <span class="keywordflow">if</span> path.endswith(<span class="stringliteral">'/'</span>):  path = path[:-1]
<a name="l00118"></a>00118                                 <span class="keywordflow">if</span> path[:2] == <span class="stringliteral">"./"</span>: path = path[2:]
<a name="l00119"></a>00119                                 <span class="keywordflow">return</span> (path, result.group(2))
<a name="l00120"></a>00120                         
<a name="l00121"></a>00121                         <span class="keywordflow">return</span> (<span class="stringliteral">''</span>, lib)
<a name="l00122"></a>00122                 uselibs = self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#o1">defaultUseLibs</a>.split()
<a name="l00123"></a>00123                 out_buf = <span class="stringliteral">""</span>
<a name="l00124"></a>00124                 <span class="keywordflow">if</span> self.self.libadds.has_key(name):
<a name="l00125"></a>00125                         convertedlibs = []
<a name="l00126"></a>00126                         libpaths = []
<a name="l00127"></a>00127                         libs = self.self.libadds[name].split()
<a name="l00128"></a>00128                         <span class="keywordflow">for</span> lib <span class="keywordflow">in</span> libs:
<a name="l00129"></a>00129                                 <span class="keywordflow">if</span> lib[:2] == <span class="stringliteral">'$('</span> <span class="keywordflow">and</span> lib[-1:] == <span class="stringliteral">')'</span>:
<a name="l00130"></a>00130                                         <span class="keywordflow">if</span> lib[2:6] == <span class="stringliteral">"LIB_"</span>:
<a name="l00131"></a>00131                                                 uselibs.append(lib[6:-1])
<a name="l00132"></a>00132                                         <span class="keywordflow">elif</span> lib[2:5] == <span class="stringliteral">"LIB"</span>:
<a name="l00133"></a>00133                                                 uselibs.append(lib[5:-1])
<a name="l00134"></a>00134                                         <span class="keywordflow">else</span>:
<a name="l00135"></a>00135                                                 <span class="keywordflow">print</span> <span class="stringliteral">"WARNING: UNKNOW makefile variable in LDADDS %s"</span> % lib
<a name="l00136"></a>00136                                 <span class="keywordflow">else</span>:
<a name="l00137"></a>00137                                         path, libname = convertLocalLibs(lib)
<a name="l00138"></a>00138                                         <span class="keywordflow">if</span> len(path) <span class="keywordflow">and</span> <span class="keywordflow">not</span> libpaths.count(path):
<a name="l00139"></a>00139                                                 libpaths.append(path)
<a name="l00140"></a>00140                                         convertedlibs.append(libname)
<a name="l00141"></a>00141                         <span class="keywordflow">if</span> len(convertedlibs):
<a name="l00142"></a>00142                                 out_buf += <span class="stringliteral">"obj.libpaths = '%s '\n"</span> % <span class="stringliteral">' '</span>.join(libpaths)
<a name="l00143"></a>00143                                 out_buf += <span class="stringliteral">"obj.libs = '%s '\n"</span> % <span class="stringliteral">' '</span>.join(convertedlibs)
<a name="l00144"></a>00144                 
<a name="l00145"></a>00145                 out_buf += <span class="stringliteral">'obj.uselib = \'%s \'\n'</span> % <span class="stringliteral">' '</span>.join(uselibs)
<a name="l00146"></a>00146                 <span class="keywordflow">return</span> out_buf
<a name="l00147"></a>00147 
<a name="l00148"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#a3">00148</a>         <span class="keyword">def </span><a class="code" href="classam2bksys_1_1AM2Bksys.html#a3">generateObj</a>(self, islib, objtype, name):
<a name="l00149"></a>00149                 <span class="keywordflow">if</span> islib:
<a name="l00150"></a>00150                         out_buf = <span class="stringliteral">"obj = %s\n"</span> % self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#o2">LibHandlerMapping</a>[objtype]
<a name="l00151"></a>00151                 <span class="keywordflow">else</span>:
<a name="l00152"></a>00152                         out_buf = <span class="stringliteral">"obj = %s\n"</span> % self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#o3">ProgHandlerMapping</a>[objtype]
<a name="l00153"></a>00153 
<a name="l00154"></a>00154                 include = <span class="stringliteral">""</span>
<a name="l00155"></a>00155                 
<a name="l00156"></a>00156                 <span class="comment">#TARGET</span>
<a name="l00157"></a>00157                 out_buf += <span class="stringliteral">"obj.target = '%s'\n"</span> % name
<a name="l00158"></a>00158                 
<a name="l00159"></a>00159                 <span class="comment">#FIXME: other LDFLAGS support</span>
<a name="l00160"></a>00160                 <span class="comment">#Version number</span>
<a name="l00161"></a>00161                 <span class="keywordflow">if</span> self.self.ldflags.has_key(name):
<a name="l00162"></a>00162                         flags = self.self.ldflags[name].split()
<a name="l00163"></a>00163                         <span class="keywordflow">if</span> islib <span class="keywordflow">and</span> flags.count(<span class="stringliteral">'-version-info'</span>) &gt; 0:
<a name="l00164"></a>00164                                 index = flags.index(<span class="stringliteral">'-version-info'</span>) + 1
<a name="l00165"></a>00165                                 <span class="keywordflow">if</span> index &lt; len(flags):
<a name="l00166"></a>00166                                         version = flags[index]
<a name="l00167"></a>00167                                         <span class="keywordflow">if</span> version.replace(<span class="stringliteral">':'</span>,<span class="stringliteral">''</span>).isdigit():
<a name="l00168"></a>00168                                                 out_buf += <span class="stringliteral">"obj.vnum = '%s'\n"</span> % version.replace(<span class="stringliteral">':'</span>,<span class="stringliteral">'.'</span>)
<a name="l00169"></a>00169                                         <span class="keywordflow">else</span>:
<a name="l00170"></a>00170                                                 <span class="keywordflow">print</span> <span class="stringliteral">"WARNING: version-info format is incorrect"</span>
<a name="l00171"></a>00171                 
<a name="l00172"></a>00172                 <span class="comment">#SOURCES</span>
<a name="l00173"></a>00173                 out_buf += <span class="stringliteral">"obj.source = %s_sources\n"</span> % name
<a name="l00174"></a>00174                 
<a name="l00175"></a>00175                 <span class="comment">#INCLUDES</span>
<a name="l00176"></a>00176                 <span class="keywordflow">if</span> self.self.includes.has_key(name):
<a name="l00177"></a>00177                         include = <span class="stringliteral">"'"</span> + self.self.includes[name] + <span class="stringliteral">"'"</span>
<a name="l00178"></a>00178                 <span class="keywordflow">elif</span> self.self.includes.has_key(<span class="stringliteral">'_DIR_GLOBAL_'</span>):
<a name="l00179"></a>00179                         include = <span class="stringliteral">'includes'</span>
<a name="l00180"></a>00180                 
<a name="l00181"></a>00181                 <span class="keywordflow">if</span> include:
<a name="l00182"></a>00182                         out_buf += <span class="stringliteral">"obj.includes = %s\n"</span> % include
<a name="l00183"></a>00183                 
<a name="l00184"></a>00184                 <span class="comment">#LIBADD</span>
<a name="l00185"></a>00185                 out_buf += self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#a2">generateLibadds</a>(name)
<a name="l00186"></a>00186                 
<a name="l00187"></a>00187                 out_buf += <span class="stringliteral">'obj.execute()\n\n'</span>
<a name="l00188"></a>00188                 
<a name="l00189"></a>00189                 <span class="keywordflow">return</span> out_buf
<a name="l00190"></a>00190 
<a name="l00191"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#a4">00191</a>         <span class="keyword">def </span><a class="code" href="classam2bksys_1_1AM2Bksys.html#a4">generateSubdirs</a>(self):
<a name="l00192"></a>00192                 out_buf = <span class="stringliteral">""</span>
<a name="l00193"></a>00193                 <span class="keywordflow">if</span> len(self.self.subdirs):
<a name="l00194"></a>00194                         dirs = self.self.subdirs.split()
<a name="l00195"></a>00195                         <span class="keywordflow">if</span> dirs.count(<span class="stringliteral">'.'</span>): del dirs[dirs.index(<span class="stringliteral">'.'</span>)]
<a name="l00196"></a>00196                         out_buf = <span class="stringliteral">"env.subdirs('%s')\n\n"</span> % <span class="stringliteral">" "</span>.join(dirs)
<a name="l00197"></a>00197                 
<a name="l00198"></a>00198                 <span class="keywordflow">return</span> out_buf;
<a name="l00199"></a>00199 
<a name="l00200"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#a5">00200</a>         <span class="keyword">def </span><a class="code" href="classam2bksys_1_1AM2Bksys.html#a5">generateData</a>(self, files, inst_dir):
<a name="l00201"></a>00201                 <span class="keyword">def </span>getKDEInstType(rawdir):
<a name="l00202"></a>00202                         <span class="keywordflow">if</span> rawdir[:2] != <span class="stringliteral">"$("</span>:
<a name="l00203"></a>00203                                 <span class="keywordflow">print</span> <span class="stringliteral">"ERROR: Do not understand data install dir format %s\n"</span> % rawdir
<a name="l00204"></a>00204                                 <span class="keywordflow">return</span> <span class="stringliteral">""</span>,<span class="stringliteral">""</span>
<a name="l00205"></a>00205                         instype = subdir = <span class="stringliteral">""</span>
<a name="l00206"></a>00206                         <span class="keywordflow">if</span> rawdir.endswith(<span class="stringliteral">")"</span>):
<a name="l00207"></a>00207                                 instype = rawdir[2:-1]
<a name="l00208"></a>00208                         <span class="keywordflow">else</span>:
<a name="l00209"></a>00209                                 reg = re.compile(<span class="stringliteral">"\$\((.*)\)/(.*)"</span>)
<a name="l00210"></a>00210                                 result = reg.match(rawdir)
<a name="l00211"></a>00211                                 <span class="keywordflow">if</span> result:
<a name="l00212"></a>00212                                         instype = result.group(1)
<a name="l00213"></a>00213                                         subdir = result.group(2)
<a name="l00214"></a>00214                                         
<a name="l00215"></a>00215                         <span class="keywordflow">if</span> <span class="keywordflow">not</span> len(instype) <span class="keywordflow">or</span> <span class="keywordflow">not</span> self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#o4">DataHandlerMapping</a>.has_key(instype):
<a name="l00216"></a>00216                                 instype = <span class="stringliteral">""</span>
<a name="l00217"></a>00217                         <span class="keywordflow">else</span>:
<a name="l00218"></a>00218                                 instype = self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#o4">DataHandlerMapping</a>[instype]
<a name="l00219"></a>00219                                 
<a name="l00220"></a>00220                         <span class="keywordflow">return</span> (instype, subdir)
<a name="l00221"></a>00221                         
<a name="l00222"></a>00222                 out_buf = <span class="stringliteral">""</span>
<a name="l00223"></a>00223                 <span class="keywordflow">if</span> len(files):
<a name="l00224"></a>00224                         (insttype, subdir) = getKDEInstType(inst_dir)
<a name="l00225"></a>00225                         <span class="keywordflow">if</span> insttype:
<a name="l00226"></a>00226                                 out_buf = <span class="stringliteral">"env.bksys_insttype('%s', '%s', '%s')\n\n"</span> % (insttype, subdir, files)
<a name="l00227"></a>00227                 <span class="keywordflow">return</span> out_buf
<a name="l00228"></a>00228 
<a name="l00229"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#a6">00229</a>         <span class="keyword">def </span><a class="code" href="classam2bksys_1_1AM2Bksys.html#a6">generateConscript</a>(self):
<a name="l00230"></a>00230                 out_buf = self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#o5">out_buf_header</a> % self.self.path
<a name="l00231"></a>00231                 
<a name="l00232"></a>00232                 self.self.getIncludes() <span class="comment">#fix path</span>
<a name="l00233"></a>00233                 
<a name="l00234"></a>00234                 out_buf += self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#a4">generateSubdirs</a>()
<a name="l00235"></a>00235                 
<a name="l00236"></a>00236                 out_buf += self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#a0">generateSources</a>()
<a name="l00237"></a>00237 
<a name="l00238"></a>00238                 out_buf += self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#a1">generateHeaders</a>()
<a name="l00239"></a>00239 
<a name="l00240"></a>00240                 <span class="comment">#find global includes setting for self dir:</span>
<a name="l00241"></a>00241                 <span class="keywordflow">if</span> self.self.includes.has_key(<span class="stringliteral">'_DIR_GLOBAL_'</span>):
<a name="l00242"></a>00242                         out_buf += <span class="stringliteral">"includes = '%s '\n\n"</span> % self.self.includes[<span class="stringliteral">'_DIR_GLOBAL_'</span>]
<a name="l00243"></a>00243                         
<a name="l00244"></a>00244                 <span class="comment">#generate library objects</span>
<a name="l00245"></a>00245                 <span class="keywordflow">for</span> libtypekey <span class="keywordflow">in</span> self.self.libs.keys():
<a name="l00246"></a>00246                         <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#o2">LibHandlerMapping</a>.has_key(libtypekey):
<a name="l00247"></a>00247                                 <span class="keywordflow">print</span> <span class="stringliteral">"ERROR: library type %s is not defined in LibHandlerMapping"</span> % libtypekey
<a name="l00248"></a>00248                                 <span class="keywordflow">return</span> 
<a name="l00249"></a>00249                         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.self.libs[libtypekey].split():
<a name="l00250"></a>00250                                 out_buf += self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#a3">generateObj</a>(1, libtypekey, key)
<a name="l00251"></a>00251                         
<a name="l00252"></a>00252                 <span class="comment">#generate program objects</span>
<a name="l00253"></a>00253                 <span class="keywordflow">for</span> progtypekey <span class="keywordflow">in</span> self.self.progs.keys():
<a name="l00254"></a>00254                         <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#o3">ProgHandlerMapping</a>.has_key(progtypekey):
<a name="l00255"></a>00255                                 <span class="keywordflow">print</span> <span class="stringliteral">"ERROR: Program type %s is not defined in ProgHandlerMapping"</span> % progtypekey
<a name="l00256"></a>00256                                 <span class="keywordflow">return</span>
<a name="l00257"></a>00257                         <span class="comment">#FIXME: implement test/check support</span>
<a name="l00258"></a>00258                         <span class="keywordflow">if</span> progtypekey <span class="keywordflow">in</span> [<span class="stringliteral">'check'</span>, <span class="stringliteral">'EXTRA'</span>]:
<a name="l00259"></a>00259                                 <span class="keywordflow">continue</span>
<a name="l00260"></a>00260                         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.self.progs[progtypekey].split():
<a name="l00261"></a>00261                                 out_buf += self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#a3">generateObj</a>(0, progtypekey, key)
<a name="l00262"></a>00262                 
<a name="l00263"></a>00263                 <span class="comment">#generate data files</span>
<a name="l00264"></a>00264                 <span class="keywordflow">for</span> dataname <span class="keywordflow">in</span> self.self.data.keys():
<a name="l00265"></a>00265                         out_buf += self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#a5">generateData</a>(self.self.data[dataname], self.self.datadirs[dataname])
<a name="l00266"></a>00266                 
<a name="l00267"></a>00267                 <span class="keywordflow">if</span> len(self.self.defines):
<a name="l00268"></a>00268                         out_buf += <span class="stringliteral">'\n"""Unhandled Defines \n'</span>
<a name="l00269"></a>00269                         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.self.defines.keys():
<a name="l00270"></a>00270                                 out_buf += key  + <span class="stringliteral">' = '</span> + self.self.defines[key] + <span class="stringliteral">"\n"</span>
<a name="l00271"></a>00271                         out_buf += <span class="stringliteral">'"""\n'</span>
<a name="l00272"></a>00272                 
<a name="l00273"></a>00273                 <span class="keywordflow">if</span> len(self.self.targets):
<a name="l00274"></a>00274                         out_buf += <span class="stringliteral">'\n"""Unhandled Targets \n'</span>
<a name="l00275"></a>00275                         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.self.targets.keys():
<a name="l00276"></a>00276                                 out_buf += key  + <span class="stringliteral">' = '</span> + self.self.targets[key] + <span class="stringliteral">"\n"</span>
<a name="l00277"></a>00277                         out_buf += <span class="stringliteral">'"""\n'</span>
<a name="l00278"></a>00278                 
<a name="l00279"></a>00279                 <span class="keywordflow">return</span> out_buf
<a name="l00280"></a>00280                 
<a name="l00281"></a>00281         <span class="keyword">def </span>getIncludes(self):
<a name="l00282"></a>00282                 amtool.AMFile.getIncludes(self)
<a name="l00283"></a>00283                 <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.self.includes.keys():
<a name="l00284"></a>00284                         self.self.includes[key] = self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#a7">convertIncludesPath</a>(self.self.includes[key])
<a name="l00285"></a>00285                 <span class="keywordflow">return</span> self.self.includes
<a name="l00286"></a>00286 
<a name="l00287"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#a7">00287</a>         <span class="keyword">def </span><a class="code" href="classam2bksys_1_1AM2Bksys.html#a7">convertIncludesPath</a>(self, paths_str):
<a name="l00288"></a>00288                 retlist = []
<a name="l00289"></a>00289                 paths = paths_str.split()
<a name="l00290"></a>00290                 <span class="keywordflow">for</span> path <span class="keywordflow">in</span> paths:
<a name="l00291"></a>00291                         <span class="keywordflow">if</span> path[:2] == <span class="stringliteral">'-I'</span>:
<a name="l00292"></a>00292                                 path = path[2:]
<a name="l00293"></a>00293                         <span class="keywordflow">if</span> path <span class="keywordflow">in</span> self.<a class="code" href="classam2bksys_1_1AM2Bksys.html#o0">ignoreIncludePaths</a>:
<a name="l00294"></a>00294                                 <span class="keywordflow">continue</span>
<a name="l00295"></a>00295                         path = path.replace(<span class="stringliteral">'$(top_srcdir)'</span>, <span class="stringliteral">'#'</span>)
<a name="l00296"></a>00296                         path = path.replace(<span class="stringliteral">'$(top_builddir)'</span>, <span class="stringliteral">'#'</span>)
<a name="l00297"></a>00297                         path = path.replace(<span class="stringliteral">'$(srcdir)/'</span>, <span class="stringliteral">''</span>)
<a name="l00298"></a>00298                         retlist.append(self.self.convertMakeFileVariable(path))
<a name="l00299"></a>00299                 <span class="keywordflow">return</span> <span class="stringliteral">' '</span>.join(retlist)
<a name="l00300"></a>00300         
<a name="l00301"></a>00301 <span class="keywordflow">if</span> len(sys.argv) == 1:
<a name="l00302"></a>00302         <span class="keywordflow">print</span> <span class="stringliteral">"am2bksys [options] Makefile.am"</span>
<a name="l00303"></a>00303         <span class="keywordflow">print</span> <span class="stringliteral">"Convert a Makefile.am to bksys SConscript"</span>
<a name="l00304"></a>00304         <span class="keywordflow">print</span> <span class="stringliteral">"options:"</span> 
<a name="l00305"></a>00305         <span class="keywordflow">print</span> <span class="stringliteral">"    -o file  Write generated SConscript to this file"</span> 
<a name="l00306"></a>00306         <span class="keywordflow">print</span> <span class="stringliteral">"    -w Write generated SConscript to the same dir as the Makefile.am"</span> 
<a name="l00307"></a>00307         <span class="keywordflow">print</span> <span class="stringliteral">"By default, am2bksys will output the generated SConscript to stdout"</span> 
<a name="l00308"></a>00308 <span class="keywordflow">else</span>:
<a name="l00309"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#s0">00309</a>         outputfile = <span class="stringliteral">""</span>
<a name="l00310"></a>00310         <span class="keywordflow">for</span> a <span class="keywordflow">in</span> range(1,len(sys.argv)):
<a name="l00311"></a>00311                 <span class="keywordflow">if</span> sys.argv[a][:2] == <span class="stringliteral">'-o'</span> <span class="keywordflow">and</span> a+1 &lt; len(sys.argv):
<a name="l00312"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#s1">00312</a>                         outputfile = sys.argv[a+1]
<a name="l00313"></a>00313                         a += 1
<a name="l00314"></a>00314                 <span class="keywordflow">elif</span> sys.argv[a][:2] == <span class="stringliteral">'-w'</span>:
<a name="l00315"></a>00315                         outputfile = <span class="stringliteral">"#"</span>
<a name="l00316"></a>00316 
<a name="l00317"></a>00317         <span class="keywordflow">for</span> a <span class="keywordflow">in</span> range(1,len(sys.argv)):
<a name="l00318"></a>00318                 <span class="keywordflow">if</span> sys.argv[a][:1] == <span class="stringliteral">'-'</span>:
<a name="l00319"></a>00319                         <span class="keywordflow">continue</span>
<a name="l00320"></a>00320                 
<a name="l00321"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#s2">00321</a>                 am_file = AM2Bksys()
<a name="l00322"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#s3">00322</a>                 inputfile = sys.argv[a];
<a name="l00323"></a>00323                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> am_file.read(inputfile):
<a name="l00324"></a>00324                         <span class="keywordflow">print</span> <span class="stringliteral">"ERROR: can not read file %s"</span> % inputfile
<a name="l00325"></a>00325                         <span class="keywordflow">continue</span>
<a name="l00326"></a>00326                 
<a name="l00327"></a>00327                 <span class="keywordflow">if</span> len(outputfile):
<a name="l00328"></a>00328                         <span class="keywordflow">try</span>:
<a name="l00329"></a>00329                                 <span class="keywordflow">if</span> outputfile == <span class="stringliteral">"#"</span>:
<a name="l00330"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#s4">00330</a>                                         outputfile = inputfile.replace(<span class="stringliteral">"Makefile.am"</span>, <span class="stringliteral">"SConscript"</span>)
<a name="l00331"></a><a class="code" href="classam2bksys_1_1AM2Bksys.html#s5">00331</a>                                 dest = open(outputfile, <span class="stringliteral">'w'</span>)
<a name="l00332"></a>00332                         <span class="keywordflow">except</span>:
<a name="l00333"></a>00333                                 exit
<a name="l00334"></a>00334                         
<a name="l00335"></a>00335                         dest.write(am_file.generateConscript())
<a name="l00336"></a>00336                         dest.close()
<a name="l00337"></a>00337                         <span class="keywordflow">print</span> <span class="stringliteral">"File %s is successfully created."</span> % outputfile
<a name="l00338"></a>00338                 <span class="keywordflow">else</span>:
<a name="l00339"></a>00339                         <span class="keywordflow">print</span> am_file.generateConscript()
<a name="l00340"></a>00340                 
<a name="l00341"></a>00341                 <span class="keywordflow">break</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun Oct 23 01:11:53 2005 for BKSYS - Build Kde SYStem by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.4 </small></address>
</body>
</html>
